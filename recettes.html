<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Recettes</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8B7EC8;
            --primary-dark: #6B5EA8;
            --primary-light: #E8E4F4;
            --accent: #F5A673;
            --accent-light: #FFE4D1;
            --success: #6AAF8B;
            --danger: #E07B7B;
            --warning: #F5C56D;
            --text-dark: #3D3554;
            --text-medium: #5D5475;
            --text-light: #8B85A0;
            --surface: #FAF8FF;
            --surface-alt: #F3F0FA;
            --border: #DDD8E8;
            --white: #FFFFFF;
            /* Option E - Couleurs crit√®res harmonis√©es */
            --crit-1: #8B7EC8;  /* Lavande */
            --crit-2: #F5A673;  /* P√™che */
            --crit-3: #6AAF8B;  /* Vert */
            --crit-4: #E07B7B;  /* Corail */
            --crit-5: #5B8DBD;  /* Bleu */
            --crit-6: #D4A84A;  /* Or */
            --crit-7: #9D6AB0;  /* Prune */
            --crit-8: #4AA88E;  /* Turquoise */
            --crit-9: #E89545;  /* Orange */
            --crit-10: #7A9EC7; /* Bleu gris */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%); min-height: 100vh; padding: 20px; padding-bottom: 100px; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--white); border-radius: 20px; box-shadow: 0 20px 60px rgba(139, 126, 200, 0.25); overflow: hidden; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); padding: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9em; }
        .sync-status { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.15); border-radius: 20px; font-size: 0.85em; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; }
        .sync-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-right { display: flex; align-items: center; gap: 10px; position: relative; }
        .user-email { font-size: 0.85em; opacity: 0.9; }
        .header-btn { padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-family: 'Montserrat', sans-serif; }
        .header-title { text-align: center; }
        .header-title h1 { font-size: 1.8em; font-weight: 700; margin-bottom: 5px; }
        .header-title p { opacity: 0.9; font-weight: 400; }
        
        /* Options Menu */
        .options-menu { position: absolute; top: 100%; right: 0; background: var(--white); border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 200px; display: none; z-index: 200; overflow: hidden; margin-top: 5px; }
        .options-menu.show { display: block; }
        .options-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; color: var(--text-dark); font-size: 0.9em; transition: background 0.2s; }
        .options-menu-item:hover { background: var(--surface-alt); }
        .options-menu-item.danger { color: var(--danger); }
        .options-menu-item input[type="file"] { display: none; }

        /* Mobile Tabs */
        .mobile-tabs { display: none; background: var(--primary-dark); }
        .mobile-tabs button { flex: 1; padding: 15px; background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 1em; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif; }
        .mobile-tabs button.active { background: rgba(255,255,255,0.1); color: white; border-bottom: 3px solid var(--accent); }

        /* Main Content */
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 30px; }
        .section { background: var(--surface); padding: 25px; border-radius: 15px; }
        .section h2 { color: var(--primary); font-size: 1.3em; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* Buttons */
        button, .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; background: var(--primary); color: var(--white); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 600; border: none; font-family: 'Montserrat', sans-serif; font-size: 0.9em; min-height: 40px; }
        button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        button:disabled { background: var(--border); color: var(--text-light); cursor: not-allowed; transform: none; }
        .btn-small { padding: 6px 12px; font-size: 0.8em; min-height: 32px; }
        .btn-icon { padding: 8px; min-height: 36px; min-width: 36px; border-radius: 8px; }
        .btn-success { background: var(--success); }
        .btn-success:hover:not(:disabled) { background: #5A9A7A; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover:not(:disabled) { background: #C96A6A; }
        .btn-warning { background: var(--warning); color: var(--text-dark); }
        .btn-accent { background: var(--accent); color: var(--white); }
        .btn-accent:hover:not(:disabled) { background: #E09560; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background: var(--primary-light); }
        .btn-outline:disabled { border-color: var(--border); color: var(--text-light); }

        /* SVG Icons */
        .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 22px; height: 22px; }
        .icon-xl { width: 30px; height: 30px; }

        /* === QUICK ACTIONS BAR (XL avec animation) === */
        .quick-actions { display: flex; gap: 12px; margin-bottom: 15px; justify-content: center; }
        .quick-action-btn { 
            position: relative; width: 64px; height: 64px; border-radius: 14px; 
            background: var(--white); border: 2px solid var(--border); color: var(--primary); 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .quick-action-btn .icon { width: 28px; height: 28px; transition: transform 0.3s; }
        .quick-action-btn:hover { 
            background: var(--primary); color: var(--white); border-color: var(--primary); 
            transform: translateY(-3px); box-shadow: 0 6px 20px rgba(139, 126, 200, 0.35);
        }
        .quick-action-btn:hover .icon { transform: scale(1.1); }
        .quick-action-btn:active { transform: translateY(-1px); }
        .quick-action-btn.active { 
            background: var(--primary); color: var(--white); border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(139, 126, 200, 0.4);
        }
        .quick-action-btn.fav { color: var(--warning); }
        .quick-action-btn.fav:hover { background: var(--warning); color: var(--text-dark); border-color: var(--warning); box-shadow: 0 6px 20px rgba(245, 197, 109, 0.4); }
        .quick-action-btn.fav.active { background: var(--warning); color: var(--text-dark); border-color: var(--warning); }
        /* Tooltip */
        .quick-action-btn::after { 
            content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; 
            transform: translateX(-50%) translateY(5px); background: var(--text-dark); color: white; 
            padding: 6px 12px; border-radius: 6px; font-size: 0.75em; font-weight: 600; white-space: nowrap; 
            opacity: 0; pointer-events: none; transition: all 0.2s;
        }
        .quick-action-btn::before {
            content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%);
            border: 6px solid transparent; border-top-color: var(--text-dark);
            opacity: 0; transition: all 0.2s;
        }
        .quick-action-btn:hover::after, .quick-action-btn:hover::before { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Action Panels (slide down) */
        .action-panel { 
            display: none; background: var(--white); border-radius: 12px; border: 2px solid var(--border); 
            margin-bottom: 15px; overflow: hidden; 
        }
        .action-panel.show { display: block; animation: panelSlide 0.3s ease-out; }
        @keyframes panelSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .action-panel-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; background: var(--surface-alt); border-bottom: 1px solid var(--border); 
        }
        .action-panel-title { font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .action-panel-close { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 4px; min-height: auto; }
        .action-panel-close:hover { color: var(--danger); background: none; transform: none; }
        .action-panel-body { padding: 15px; }

        /* Top Criteria Chips */
        .top-criteria { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .criteria-chip { 
            display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; 
            border-radius: 20px; font-size: 0.8em; font-weight: 600; cursor: pointer; 
            transition: all 0.2s; border: none; color: var(--white); 
        }
        .criteria-chip:hover { transform: scale(1.05); filter: brightness(1.1); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .criteria-chip .count { background: rgba(255,255,255,0.3); padding: 2px 7px; border-radius: 10px; font-size: 0.85em; }

        /* Random Mode Banner */
        .random-mode-banner { 
            display: none; background: linear-gradient(135deg, var(--accent), var(--warning)); 
            color: var(--text-dark); padding: 12px 15px; border-radius: 10px; margin-bottom: 12px; 
            align-items: center; justify-content: space-between; font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 166, 115, 0.3);
        }
        .random-mode-banner.show { display: flex; animation: bannerPop 0.3s ease-out; }
        @keyframes bannerPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Select All Button */
        .select-all-btn { margin-left: auto; }

        /* Stats */
        .stats-bar { display: flex; gap: 15px; padding: 12px 16px; background: var(--white); border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--border); flex-wrap: wrap; }
        .stat-item { display: flex; align-items: center; gap: 8px; }
        .stat-number { font-size: 1.4em; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-light); font-size: 0.85em; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95em; font-family: 'Montserrat', sans-serif; background: var(--white); color: var(--text-dark); transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }

        /* Tags */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 40px; padding: 10px; background: var(--surface-alt); border-radius: 8px; border: 2px dashed var(--border); }
        .tags-container:empty::before { content: attr(data-placeholder); color: var(--text-light); font-style: italic; font-size: 0.9em; }
        .tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary); color: var(--white); border-radius: 20px; font-size: 0.85em; font-weight: 500; animation: tagPop 0.2s ease-out; }
        .tag-remove { cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .tag-remove:hover { opacity: 1; }
        .tag.include { background: var(--success); }
        .tag.exclude { background: var(--danger); }
        @keyframes tagPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hint { font-size: 0.8em; color: var(--text-light); margin-top: 5px; font-style: italic; }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border: 2px solid var(--primary); border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--surface-alt); font-size: 0.9em; transition: background 0.2s; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background: var(--surface-alt); }
        .autocomplete-item.selected { background: var(--primary); color: var(--white); }
        .autocomplete-item.selected .autocomplete-highlight { color: var(--accent); }
        .autocomplete-highlight { font-weight: 700; color: var(--accent); }

        /* Search & Filters */
        .search-box { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 0.95em; font-family: 'Montserrat', sans-serif; margin-bottom: 15px; background: var(--white); transition: border-color 0.2s; }
        .search-box:focus { outline: none; border-color: var(--primary); }
        .list-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .view-toggle, .sort-toggle { display: flex; background: var(--surface-alt); border-radius: 8px; overflow: hidden; border: 2px solid var(--border); }
        .view-toggle button, .sort-toggle button { padding: 8px 14px; background: transparent; border: none; color: var(--text-medium); font-weight: 600; cursor: pointer; min-height: auto; font-size: 0.85em; transition: all 0.2s; font-family: 'Montserrat', sans-serif; }
        .view-toggle button:hover, .sort-toggle button:hover { transform: none; background: var(--primary-light); }
        .view-toggle button.active, .sort-toggle button.active { background: var(--primary); color: var(--white); }

        /* Recipe List */
        .recipe-list { max-height: 500px; overflow-y: auto; overflow-x: hidden; }
        
        /* Recipe Compact - SWIPE */
        .recipe-compact-wrapper { position: relative; overflow: hidden; margin-bottom: 8px; border-radius: 10px; }
        .recipe-compact { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--white); border-radius: 10px; border: 2px solid var(--border); transition: transform 0.3s ease, border-color 0.2s; position: relative; z-index: 2; }
        .recipe-compact:hover { border-color: var(--accent); }
        .recipe-compact.selected { background: var(--primary-light); border-color: var(--primary); }
        .recipe-compact.favorite { border-left: 4px solid var(--warning); }
        .recipe-compact.swiped { transform: translateX(-140px); }
        
        /* Swipe Actions */
        .swipe-actions { position: absolute; right: 0; top: 0; bottom: 0; width: 140px; display: flex; align-items: stretch; z-index: 1; border-radius: 0 10px 10px 0; overflow: hidden; }
        .swipe-action { flex: 1; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: opacity 0.2s; }
        .swipe-action.fav { background: var(--warning); color: var(--text-dark); }
        .swipe-action.edit { background: var(--primary); color: var(--white); }
        .swipe-action.delete { background: var(--danger); color: var(--white); }
        .swipe-action .icon { width: 20px; height: 20px; }

        .recipe-checkbox-zone { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; margin: -10px; margin-right: 4px; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
        .recipe-checkbox-zone:hover { background: var(--primary-light); }
        .recipe-compact-checkbox { width: 22px; height: 22px; border: 2px solid var(--primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .recipe-compact.selected .recipe-compact-checkbox { background: var(--primary); }
        .recipe-compact-checkbox .icon { opacity: 0; color: var(--white); transition: opacity 0.2s; }
        .recipe-compact.selected .recipe-compact-checkbox .icon { opacity: 1; }
        .recipe-compact-main { flex: 1; cursor: pointer; padding: 4px 0; }
        .recipe-compact-name { font-weight: 600; color: var(--text-dark); font-size: 0.95em; display: flex; align-items: center; gap: 6px; }
        .recipe-compact-name .icon { color: var(--warning); width: 16px; height: 16px; fill: var(--warning); stroke: var(--warning); }
        .recipe-compact-meta { display: flex; gap: 10px; margin-top: 4px; color: var(--text-light); font-size: 0.8em; }

        /* Recipe Inline Detail */
        .recipe-inline-detail { background: var(--white); border: 2px solid var(--primary); border-top: none; border-radius: 0 0 10px 10px; margin-top: -10px; margin-bottom: 8px; padding: 15px; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 300px; } }
        .recipe-inline-detail-section { margin-bottom: 12px; }
        .recipe-inline-detail-section strong { color: var(--primary); font-size: 0.85em; display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
        .recipe-inline-detail-section p { color: var(--text-medium); font-size: 0.9em; line-height: 1.5; }
        .recipe-inline-detail-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .recipe-tag { padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 600; }
        .recipe-tag.criteria { background: var(--primary-light); color: var(--primary-dark); }
        .recipe-tag.usage { background: var(--accent); color: var(--white); }
        .recipe-inline-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border); }

        /* Shopping List */
        .shopping-list { max-height: 400px; overflow-y: auto; }
        .shopping-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--white); margin-bottom: 6px; border-radius: 8px; border: 2px solid var(--border); transition: all 0.2s; user-select: none; }
        .shopping-item.zero { opacity: 0.4; }
        .shopping-item.dragging { opacity: 0.5; transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 100; }
        
        .drop-indicator { height: 3px; background: var(--accent); border-radius: 2px; margin: -3px 0; opacity: 0; transition: opacity 0.2s; }
        .drop-indicator.visible { opacity: 1; margin: 4px 0; }
        
        .drag-handle { cursor: grab; color: var(--text-light); padding: 4px; display: flex; align-items: center; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        .shopping-item-name { flex: 1; font-weight: 500; color: var(--text-dark); font-size: 0.9em; }
        .shopping-item-controls { display: flex; align-items: center; gap: 5px; }
        .qty-btn { width: 28px; height: 28px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: var(--white); padding: 0; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; font-family: 'Montserrat', sans-serif; }
        .qty-btn:hover { transform: scale(1.1); }
        .qty-btn.minus { background: var(--danger); }
        .qty-btn.plus { background: var(--success); }
        .shopping-item-count { background: var(--accent); color: var(--white); padding: 4px 10px; border-radius: 10px; font-size: 0.8em; font-weight: 600; min-width: 35px; text-align: center; }
        
        .list-title { font-size: 1em; font-weight: 600; color: var(--primary); padding: 12px; background: var(--white); border-radius: 8px; border: 2px solid var(--primary); text-align: center; margin-bottom: 15px; }
        .shopping-recipes { margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--border); }
        .shopping-recipes-title { font-weight: 600; color: var(--primary); margin-bottom: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
        .shopping-recipe-item { display: flex; align-items: center; padding: 8px 12px; background: var(--white); border-radius: 6px; margin-bottom: 6px; border: 1px solid var(--border); font-size: 0.85em; }
        .shopping-recipe-item span { flex: 1; color: var(--text-dark); }
        .shopping-recipe-item .remove-recipe-btn { background: var(--danger); color: var(--white); border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-family: 'Montserrat', sans-serif; font-weight: 500; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
        .empty-state p { font-size: 0.95em; margin-bottom: 15px; }

        /* Action Bar */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); padding: 15px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 15px; z-index: 100; }
        .action-bar button { min-width: 140px; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; padding-bottom: 90px; }
            .main-content { grid-template-columns: 1fr; gap: 20px; padding: 15px; }
            .section { padding: 15px; }
            .mobile-tabs { display: flex; }
            .section.hidden-mobile { display: none; }
            .section.show-mobile { display: block; }
            .action-bar button { min-width: auto; flex: 1; font-size: 0.85em; padding: 12px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface-alt); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Modal Backoffice */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--white); border-radius: 16px; max-width: 800px; width: 100%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.3em; font-weight: 700; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1.2em; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* Cat√©gories Backoffice */
        .category-section { margin-bottom: 25px; }
        .category-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 10px 15px; border-radius: 10px; font-weight: 600; }
        .category-header.cat-frais { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); color: #1565C0; }
        .category-header.cat-sec { background: linear-gradient(135deg, #FFF3E0, #FFE0B2); color: #E65100; }
        .category-header.cat-congele { background: linear-gradient(135deg, #E0F7FA, #B2EBF2); color: #00838F; }
        .category-header.cat-nonclasse { background: linear-gradient(135deg, #F5F5F5, #EEEEEE); color: #616161; }
        .category-icon { font-size: 1.3em; }
        .category-count { margin-left: auto; background: rgba(0,0,0,0.1); padding: 2px 10px; border-radius: 12px; font-size: 0.85em; }

        .ingredients-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .ingredient-chip { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--white); border: 2px solid var(--border); border-radius: 20px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .ingredient-chip:hover { border-color: var(--primary); background: var(--primary-light); }
        .ingredient-chip.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .ingredient-chip .chip-category { width: 8px; height: 8px; border-radius: 50%; }
        .ingredient-chip .chip-category.cat-frais { background: #1976D2; }
        .ingredient-chip .chip-category.cat-sec { background: #F57C00; }
        .ingredient-chip .chip-category.cat-congele { background: #00ACC1; }
        .ingredient-chip .chip-category.cat-nonclasse { background: #9E9E9E; }

        /* Actions cat√©gorie */
        .category-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: var(--surface-alt); border-radius: 10px; }
        .category-actions span { color: var(--text-medium); font-size: 0.9em; margin-right: 10px; align-self: center; }
        .cat-btn { padding: 8px 16px; border-radius: 8px; border: 2px solid transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'Montserrat', sans-serif; }
        .cat-btn.cat-frais { background: #E3F2FD; color: #1565C0; border-color: #90CAF9; }
        .cat-btn.cat-frais:hover { background: #1976D2; color: white; }
        .cat-btn.cat-sec { background: #FFF3E0; color: #E65100; border-color: #FFCC80; }
        .cat-btn.cat-sec:hover { background: #F57C00; color: white; }
        .cat-btn.cat-congele { background: #E0F7FA; color: #00838F; border-color: #80DEEA; }
        .cat-btn.cat-congele:hover { background: #00ACC1; color: white; }
        .cat-btn.cat-nonclasse { background: #F5F5F5; color: #616161; border-color: #BDBDBD; }
        .cat-btn.cat-nonclasse:hover { background: #9E9E9E; color: white; }

        /* Liste de courses par cat√©gorie */
        .shopping-category { margin-bottom: 20px; }
        .shopping-category-header { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; font-size: 0.95em; }
        .shopping-category-header.cat-frais { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); color: #1565C0; }
        .shopping-category-header.cat-sec { background: linear-gradient(135deg, #FFF3E0, #FFE0B2); color: #E65100; }
        .shopping-category-header.cat-congele { background: linear-gradient(135deg, #E0F7FA, #B2EBF2); color: #00838F; }
        .shopping-category-header.cat-nonclasse { background: linear-gradient(135deg, #F5F5F5, #EEEEEE); color: #616161; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-left">
                    <a href="index.html" class="back-btn">‚Üê Retour</a>
                    <div class="sync-status">
                        <div class="sync-dot" id="syncDot"></div>
                        <span id="syncText">Synchronis√©</span>
                    </div>
                </div>
                <div class="header-right">
                    <span class="user-email" id="userEmail">...</span>
                    <button class="header-btn" onclick="toggleOptionsMenu()">‚öôÔ∏è Options</button>
                    <div class="options-menu" id="optionsMenu">
                        <div class="options-menu-item" onclick="openBackoffice(); closeOptionsMenu();">
                            <svg class="icon icon-sm"><use href="#icon-list"/></svg> Cat√©gories ingr√©dients
                        </div>
                        <label class="options-menu-item">
                            <svg class="icon icon-sm"><use href="#icon-upload"/></svg> Importer CSV
                            <input type="file" id="csvImport" accept=".csv">
                        </label>
                        <div class="options-menu-item" onclick="exportCSV(); closeOptionsMenu();">
                            <svg class="icon icon-sm"><use href="#icon-download"/></svg> Exporter CSV
                        </div>
                        <div class="options-menu-item danger" onclick="handleLogout()">
                            <svg class="icon icon-sm"><use href="#icon-logout"/></svg> D√©connexion
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-title">
                <h1>Mes Recettes</h1>
                <p>Synchronis√©es automatiquement</p>
            </div>
        </header>

        <div class="mobile-tabs">
            <button class="active" onclick="switchTab('recipes')">üìö Recettes</button>
            <button onclick="switchTab('shopping')">üõí Liste</button>
        </div>

        <div class="main-content">
            <!-- LEFT: Recipes -->
            <div class="section show-mobile" id="recipesSection">
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-number" id="totalCount">0</span><span class="stat-label">recettes</span></div>
                    <div class="stat-item"><span class="stat-number" id="selectedCount">0</span><span class="stat-label">s√©lectionn√©es</span></div>
                    <div class="stat-item"><span class="stat-number" id="favCount">0</span><span class="stat-label">favoris</span></div>
                </div>

                <!-- Quick Actions Bar (XL) -->
                <div class="quick-actions">
                    <button class="quick-action-btn" data-tooltip="Ajouter une recette" data-panel="addPanel" onclick="togglePanel('addPanel')">
                        <svg class="icon"><use href="#icon-plus"/></svg>
                    </button>
                    <button class="quick-action-btn" data-tooltip="Tirage al√©atoire" data-panel="randomPanel" onclick="togglePanel('randomPanel')">
                        <svg class="icon"><use href="#icon-shuffle"/></svg>
                    </button>
                    <button class="quick-action-btn" data-tooltip="Filtres" data-panel="filterPanel" onclick="togglePanel('filterPanel')">
                        <svg class="icon"><use href="#icon-filter"/></svg>
                    </button>
                    <button class="quick-action-btn fav" data-tooltip="Favoris uniquement" id="favoritesBtn" onclick="toggleFavoritesFilter()">
                        <svg class="icon"><use href="#icon-star"/></svg>
                    </button>
                </div>

                <!-- Add Recipe Panel -->
                <div class="action-panel" id="addPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-plus"/></svg> <span id="formTitle">Nouvelle recette</span></span>
                        <button class="action-panel-close" onclick="closePanel('addPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div class="form-group">
                            <label>Nom de la recette</label>
                            <input type="text" id="recipeName" placeholder="Ex: P√¢tes carbonara">
                        </div>
                        <div class="form-group">
                            <label>Ingr√©dients</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="recipeIngredients" placeholder="Tapez puis Tab ou Entr√©e" autocomplete="off">
                                <div class="autocomplete-dropdown" id="ingredientsAutocomplete"></div>
                            </div>
                            <div class="hint">‚Üë‚Üì naviguer ‚Ä¢ Tab/Entr√©e valider ‚Ä¢ √âchap fermer</div>
                            <div class="tags-container" id="ingredientTags" data-placeholder="Les ingr√©dients appara√Ætront ici..."></div>
                        </div>
                        <div class="form-group">
                            <label>Crit√®res</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="recipeCriteria" placeholder="Ex: Rapide, Facile..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="criteriaAutocomplete"></div>
                            </div>
                            <div class="tags-container" id="criteriaTags" data-placeholder="Les crit√®res appara√Ætront ici..."></div>
                            <div class="top-criteria" id="topCriteria"></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn-outline" onclick="resetForm()"><svg class="icon icon-sm"><use href="#icon-refresh"/></svg> R√©init.</button>
                            <button class="btn-success" onclick="saveRecipe()"><svg class="icon icon-sm"><use href="#icon-check"/></svg> Sauvegarder</button>
                        </div>
                    </div>
                </div>

                <!-- Random Panel -->
                <div class="action-panel" id="randomPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-shuffle"/></svg> Tirage al√©atoire</span>
                        <button class="action-panel-close" onclick="closePanel('randomPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <button class="btn-accent" onclick="randomize()"><svg class="icon icon-sm"><use href="#icon-shuffle"/></svg> Surprise !</button>
                            <div style="display: flex; align-items: center; background: var(--surface-alt); border-radius: 8px; border: 2px solid var(--border);">
                                <button class="btn-small" onclick="changeRandomCount(-1)" style="background: transparent; color: var(--text-dark);">‚àí</button>
                                <input type="text" id="randomCount" value="5" readonly style="width: 40px; text-align: center; border: none; background: transparent; font-weight: 600; font-family: 'Montserrat', sans-serif;">
                                <button class="btn-small" onclick="changeRandomCount(1)" style="background: transparent; color: var(--text-dark);">+</button>
                            </div>
                            <span style="color: var(--text-light); font-size: 0.85em;">recettes</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div class="action-panel" id="filterPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-filter"/></svg> Filtres</span>
                        <button class="action-panel-close" onclick="closePanel('filterPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div class="form-group">
                            <label>Par ingr√©dient</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="filterIngredients" placeholder="Filtrer par ingr√©dient..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="filterIngredientsAutocomplete"></div>
                            </div>
                            <div class="hint">Vert = AVEC ‚Ä¢ Rouge = SANS (cliquer pour changer)</div>
                            <div class="tags-container" id="filterIngredientsTags" data-placeholder=""></div>
                        </div>
                        <div class="form-group">
                            <label>Par crit√®re</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="filterCriteria" placeholder="Filtrer par crit√®re..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="filterCriteriaAutocomplete"></div>
                            </div>
                            <div class="tags-container" id="filterCriteriaTags" data-placeholder=""></div>
                            <div class="top-criteria" id="topCriteriaFilter"></div>
                        </div>
                        <button class="btn-outline btn-small" onclick="resetFilters()"><svg class="icon icon-sm"><use href="#icon-refresh"/></svg> R√©initialiser filtres</button>
                    </div>
                </div>

                <!-- Random Mode Banner -->
                <div class="random-mode-banner" id="randomModeBanner">
                    <span>üé≤ <span id="randomModeCount">0</span> recettes tir√©es au sort</span>
                    <button class="btn-small" onclick="exitRandomMode()">Voir toutes</button>
                </div>

                <input type="text" class="search-box" id="searchBox" placeholder="üîç Rechercher une recette...">

                <div class="list-controls">
                    <div class="view-toggle">
                        <button class="active" onclick="setView('compact')">Compact</button>
                        <button onclick="setView('detailed')">D√©taill√©</button>
                    </div>
                    <div class="sort-toggle">
                        <button class="active" onclick="setSort('alpha')">A-Z</button>
                        <button onclick="setSort('usage')">Usage</button>
                    </div>
                    <button class="btn-outline btn-small select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">‚òëÔ∏è Tout s√©lect.</button>
                </div>

                <div class="recipe-list" id="recipeList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è≥</div>
                        <p>Chargement...</p>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Shopping List -->
            <div class="section hidden-mobile" id="shoppingSection">
                <h2><svg class="icon icon-lg"><use href="#icon-cart"/></svg> Liste de courses</h2>
                <div id="listTitleContainer" style="display: none;"><div class="list-title" id="listTitle"></div></div>
                <div class="shopping-list" id="shoppingList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <p>S√©lectionnez des recettes puis g√©n√©rez votre liste</p>
                    </div>
                </div>
                <div id="shoppingRecipes" class="shopping-recipes" style="display: none;">
                    <div class="shopping-recipes-title"><svg class="icon icon-sm"><use href="#icon-list"/></svg> Recettes incluses</div>
                    <div id="shoppingRecipesList"></div>
                </div>
                <div id="shoppingActions" style="display: none; margin-top: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="copyShoppingList()"><svg class="icon icon-sm"><use href="#icon-copy"/></svg> Copier</button>
                        <button class="btn-danger" onclick="clearShoppingList()"><svg class="icon icon-sm"><use href="#icon-trash"/></svg> Vider</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button onclick="addToShoppingList()" id="generateBtn" disabled><svg class="icon icon-sm"><use href="#icon-cart"/></svg> <span id="generateBtnText">G√©n√©rer la liste</span></button>
        <button onclick="clearSelection()" class="btn-outline" id="clearBtn" disabled><svg class="icon icon-sm"><use href="#icon-x"/></svg> D√©s√©lectionner</button>
    </div>

    <!-- SVG Icons -->
    <svg style="display: none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
        <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></symbol>
        <symbol id="icon-star-filled" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        <symbol id="icon-cart" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></symbol>
        <symbol id="icon-filter" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
        <symbol id="icon-list" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></symbol>
        <symbol id="icon-grip" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></symbol>
        <symbol id="icon-minus" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/></symbol>
        <symbol id="icon-shuffle" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></symbol>
        <symbol id="icon-download" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></symbol>
    </svg>

    <!-- Modal Backoffice Cat√©gories -->
    <div class="modal-overlay" id="backofficeModal" onclick="if(event.target===this)closeBackoffice()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Cat√©gories d'ingr√©dients</h2>
                <button class="modal-close" onclick="closeBackoffice()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-medium); margin-bottom: 15px; font-size: 0.9em;">
                    Cliquez sur les ingr√©dients pour les s√©lectionner, puis assignez-les √† une cat√©gorie.
                    Les cat√©gories serviront de s√©parateurs dans votre liste de courses.
                </p>

                <div class="category-actions" id="categoryActions" style="display: none;">
                    <span><strong id="selectedCountBO">0</strong> s√©lectionn√©(s) ‚Üí</span>
                    <button class="cat-btn cat-frais" onclick="assignCategory('frais')">ü•¨ Frais</button>
                    <button class="cat-btn cat-sec" onclick="assignCategory('sec')">ü•´ Sec</button>
                    <button class="cat-btn cat-congele" onclick="assignCategory('congele')">üßä Congel√©</button>
                    <button class="cat-btn cat-nonclasse" onclick="assignCategory('nonclasse')">üì¶ Non class√©</button>
                </div>

                <div id="backofficeContent">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fejvhzvpxsrzclsdsfnx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlanZoenZweHNyemNsc2RzZm54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjUxMTcsImV4cCI6MjA4MTkwMTExN30.bjaGtfZ7WHIyI8Vhkbpa-ftL4U9a88iYe6QA1hClr4A';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let recipes = [];
        let selectedRecipes = new Set();
        let allIngredients = new Set();
        let allCriteria = new Set();
        let editingRecipeId = null;
        let currentView = 'compact';
        let currentSort = 'alpha';
        let currentTab = 'recipes';
        let expandedRecipeId = null;
        let currentIngredients = [];
        let currentCriteriaList = [];
        let filterIngredientsList = [];
        let filterCriteriaList = [];
        let showOnlyFavorites = false;
        let currentShoppingList = {};
        let currentShoppingRecipes = new Set();
        let shoppingOrder = [];
        let autocompleteStates = {};
        let isMobile = 'ontouchstart' in window;

        // ============================================
        // SYNC STATUS
        // ============================================
        function setSyncStatus(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            dot.className = 'sync-dot';
            if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Sauvegarde...'; }
            else if (status === 'error') { dot.classList.add('error'); text.textContent = 'Erreur'; }
            else { text.textContent = 'Synchronis√©'; }
        }

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return false; }
            document.getElementById('userEmail').textContent = session.user.email;
            return true;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = 'login.html';
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadRecipes() {
            try {
                setSyncStatus('syncing');
                const { data, error } = await supabaseClient.from('recipes').select('*').order('created_at', { ascending: false });
                if (error) throw error;

                recipes = (data || []).map(r => ({
                    id: r.id,
                    name: r.name,
                    ingredients: r.ingredients || [],
                    double: r.double_portion || false,
                    criteria: r.criteria || [],
                    usageCount: r.usage_count || 0,
                    favorite: r.favorite || false
                }));

                updateAllIngredients();
                updateAllCriteria();
                updateStats();
                renderRecipes();
                updateButtonStates();
                renderTopCriteria();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
                document.getElementById('recipeList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Erreur de chargement</p><button onclick="loadRecipes()">R√©essayer</button></div>';
            }
        }

        function updateAllIngredients() { allIngredients.clear(); recipes.forEach(r => r.ingredients.forEach(i => allIngredients.add(i))); }
        function updateAllCriteria() { allCriteria.clear(); recipes.forEach(r => r.criteria.forEach(c => allCriteria.add(c))); }
        function updateStats() {
            document.getElementById('totalCount').textContent = recipes.length;
            document.getElementById('selectedCount').textContent = selectedRecipes.size;
            document.getElementById('favCount').textContent = recipes.filter(r => r.favorite).length;
        }
        function updateButtonStates() {
            document.getElementById('generateBtn').disabled = selectedRecipes.size === 0;
            document.getElementById('clearBtn').disabled = selectedRecipes.size === 0;
            document.getElementById('generateBtnText').textContent = currentShoppingRecipes.size > 0 ? 'Ajouter √† la liste' : 'G√©n√©rer la liste';
            
            // V7: Update select all button text
            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                const allSelected = visibleRecipeIds.length > 0 && visibleRecipeIds.every(id => selectedRecipes.has(id));
                selectAllBtn.innerHTML = allSelected ? '‚òê Tout d√©s√©lect.' : '‚òëÔ∏è Tout s√©lect.';
            }
        }

        // ============================================
        // AUTOCOMPLETE
        // ============================================
        function setupAutocomplete() {
            const configs = [
                { inputId: 'recipeIngredients', dropdownId: 'ingredientsAutocomplete', dataset: () => allIngredients, onSelect: addIngredient },
                { inputId: 'recipeCriteria', dropdownId: 'criteriaAutocomplete', dataset: () => allCriteria, onSelect: addCriteria },
                { inputId: 'filterIngredients', dropdownId: 'filterIngredientsAutocomplete', dataset: () => allIngredients, onSelect: addFilterIngredient },
                { inputId: 'filterCriteria', dropdownId: 'filterCriteriaAutocomplete', dataset: () => allCriteria, onSelect: addFilterCriteria }
            ];
            configs.forEach(cfg => {
                const input = document.getElementById(cfg.inputId);
                const dropdown = document.getElementById(cfg.dropdownId);
                autocompleteStates[cfg.inputId] = { idx: -1, items: [] };
                
                input.addEventListener('input', function() {
                    const q = this.value.trim();
                    if (q.length >= 2) showAutocomplete(cfg.inputId, cfg.dropdownId, getSuggestions(q, cfg.dataset()), q);
                    else hideAutocomplete(cfg.dropdownId);
                });
                
                input.addEventListener('keydown', function(e) {
                    const st = autocompleteStates[cfg.inputId];
                    const isOpen = dropdown.classList.contains('show');
                    if (e.key === 'ArrowDown') { e.preventDefault(); if (isOpen && st.items.length) { st.idx = Math.min(st.idx + 1, st.items.length - 1); updateACSelection(cfg.dropdownId, st.idx); } }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); if (isOpen && st.items.length) { st.idx = Math.max(st.idx - 1, 0); updateACSelection(cfg.dropdownId, st.idx); } }
                    else if (e.key === 'Tab') { if (isOpen && st.items.length) { e.preventDefault(); cfg.onSelect(st.idx >= 0 ? st.items[st.idx] : st.items[0]); this.value = ''; hideAutocomplete(cfg.dropdownId); } }
                    else if (e.key === 'Enter') { e.preventDefault(); if (isOpen && st.idx >= 0) cfg.onSelect(st.items[st.idx]); else if (this.value.trim()) { this.value.trim().split(';').forEach(v => v.trim() && cfg.onSelect(v.trim())); } this.value = ''; hideAutocomplete(cfg.dropdownId); }
                    else if (e.key === 'Escape') hideAutocomplete(cfg.dropdownId);
                });
                input.addEventListener('blur', () => setTimeout(() => hideAutocomplete(cfg.dropdownId), 200));
            });
        }
        
        // Normalise une cha√Æne : enl√®ve accents + minuscules
        function normalize(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }
        
        function getSuggestions(q, data) {
            const qNorm = normalize(q);
            return Array.from(data).filter(i => normalize(i).includes(qNorm))
                .sort((a, b) => normalize(a).startsWith(qNorm) ? -1 : normalize(b).startsWith(qNorm) ? 1 : a.localeCompare(b))
                .slice(0, 8);
        }
        function showAutocomplete(inputId, dropdownId, items, q) {
            const dd = document.getElementById(dropdownId); const st = autocompleteStates[inputId];
            if (!items.length) { hideAutocomplete(dropdownId); return; }
            st.items = items; st.idx = -1;
            dd.innerHTML = items.map((s, i) => `<div class="autocomplete-item" data-i="${i}" onmousedown="selectAC('${inputId}','${dropdownId}',${i})">${s.replace(new RegExp('(' + q + ')', 'gi'), '<span class="autocomplete-highlight">$1</span>')}</div>`).join('');
            dd.classList.add('show');
        }
        function hideAutocomplete(id) { document.getElementById(id)?.classList.remove('show'); }
        function updateACSelection(id, idx) {
            document.getElementById(id).querySelectorAll('.autocomplete-item').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
                if (i === idx) el.scrollIntoView({ block: 'nearest' });
            });
        }
        function selectAC(inputId, dropdownId, i) {
            const st = autocompleteStates[inputId];
            const handlers = { recipeIngredients: addIngredient, recipeCriteria: addCriteria, filterIngredients: addFilterIngredient, filterCriteria: addFilterCriteria };
            handlers[inputId](st.items[i]);
            document.getElementById(inputId).value = '';
            hideAutocomplete(dropdownId);
        }

        // ============================================
        // FILTERING (factoris√© + optimis√©)
        // ============================================
        function getFilteredRecipes(options = {}) {
            const { 
                includeRandomMode = true,  // Respecter le mode random
                searchText = ''            // Recherche par nom
            } = options;
            
            const searchNorm = normalize(searchText);
            
            // Pr√©-normaliser les filtres (1 seule fois, pas √† chaque recette)
            const ingFiltersNorm = filterIngredientsList.map(f => ({ mode: f.mode, nameNorm: normalize(f.name) }));
            const critFiltersNorm = filterCriteriaList.map(f => ({ mode: f.mode, nameNorm: normalize(f.name) }));
            
            return recipes.filter(r => {
                // Random mode filter
                if (includeRandomMode && randomModeIds !== null && !randomModeIds.has(r.id)) return false;
                
                // Recherche par nom (contient)
                if (searchNorm && !normalize(r.name).includes(searchNorm)) return false;
                
                // Favoris uniquement
                if (showOnlyFavorites && !r.favorite) return false;
                
                // Filtre ingr√©dients : comparaison EXACTE
                for (let f of ingFiltersNorm) {
                    const has = r.ingredients.some(i => normalize(i) === f.nameNorm);
                    if (f.mode === 'include' && !has) return false;
                    if (f.mode === 'exclude' && has) return false;
                }
                
                // Filtre crit√®res : comparaison EXACTE
                for (let f of critFiltersNorm) {
                    const has = r.criteria.some(c => normalize(c) === f.nameNorm);
                    if (f.mode === 'include' && !has) return false;
                    if (f.mode === 'exclude' && has) return false;
                }
                
                return true;
            });
        }

        // ============================================
        // RENDER RECIPES
        // ============================================
        function renderRecipes() {
            const list = document.getElementById('recipeList');
            const search = document.getElementById('searchBox').value;
            
            let filtered = getFilteredRecipes({ searchText: search });
            
            // Tri
            if (currentSort === 'alpha') filtered.sort((a, b) => a.name.localeCompare(b.name));
            else filtered.sort((a, b) => b.usageCount - a.usageCount);
            
            // V7: Track visible recipe IDs for select all
            visibleRecipeIds = filtered.map(r => r.id);
            
            if (recipes.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëã</div><p>Bienvenue ! Ajoutez votre premi√®re recette.</p><button onclick="togglePanel(\'addPanel\')">Ajouter une recette</button></div>';
                return;
            }
            if (!filtered.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Aucune recette ne correspond</p><button class="btn-outline" onclick="resetFilters()">R√©initialiser</button></div>';
                return;
            }
            
            list.innerHTML = filtered.map(r => renderCompactRecipe(r)).join('');
            if (isMobile) setupSwipe();
            updateButtonStates();
        }
        
        function renderCompactRecipe(r) {
            const sel = selectedRecipes.has(r.id);
            const exp = currentView === 'detailed' || expandedRecipeId === r.id;
            
            let html = `<div class="recipe-compact-wrapper" data-id="${r.id}">
                <div class="swipe-actions">
                    <button class="swipe-action fav" onclick="toggleFavorite('${r.id}')"><svg class="icon"><use href="#icon-star${r.favorite ? '-filled' : ''}"/></svg></button>
                    <button class="swipe-action edit" onclick="editRecipe('${r.id}')"><svg class="icon"><use href="#icon-edit"/></svg></button>
                    <button class="swipe-action delete" onclick="deleteRecipe('${r.id}')"><svg class="icon"><use href="#icon-trash"/></svg></button>
                </div>
                <div class="recipe-compact ${sel ? 'selected' : ''} ${r.favorite ? 'favorite' : ''}" data-id="${r.id}" style="${exp ? 'border-radius: 10px 10px 0 0;' : ''}">
                    <div class="recipe-checkbox-zone" onclick="toggleSelection('${r.id}')">
                        <div class="recipe-compact-checkbox"><svg class="icon icon-sm"><use href="#icon-check"/></svg></div>
                    </div>
                    <div class="recipe-compact-main" onclick="toggleExp('${r.id}')">
                        <div class="recipe-compact-name">
                            ${r.favorite ? '<svg class="icon icon-sm"><use href="#icon-star-filled"/></svg>' : ''}
                            ${r.name}
                        </div>
                        <div class="recipe-compact-meta">
                            ${r.usageCount > 0 ? `<span>${r.usageCount}√ó utilis√©e</span>` : '<span>Jamais utilis√©e</span>'}
                            ${r.criteria.length ? `<span>${r.criteria[0]}</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>`;
            
            if (exp) {
                html += `<div class="recipe-inline-detail">
                    <div class="recipe-inline-detail-section">
                        <strong><svg class="icon icon-sm"><use href="#icon-list"/></svg> Ingr√©dients</strong>
                        <p>${r.ingredients.join(' ‚Ä¢ ')}</p>
                    </div>
                    <div class="recipe-inline-detail-tags">
                        ${r.usageCount > 0 ? `<span class="recipe-tag usage">${r.usageCount}√ó utilis√©e</span>` : ''}
                        ${r.criteria.map(c => `<span class="recipe-tag criteria">${c}</span>`).join('')}
                    </div>
                    <div class="recipe-inline-actions">
                        <button class="btn-small" onclick="toggleFavorite('${r.id}')"><svg class="icon icon-sm"><use href="#icon-star${r.favorite ? '-filled' : ''}"/></svg> ${r.favorite ? 'Retirer' : 'Favoris'}</button>
                        <button class="btn-small" onclick="editRecipe('${r.id}')"><svg class="icon icon-sm"><use href="#icon-edit"/></svg> Modifier</button>
                        <button class="btn-small btn-danger" onclick="deleteRecipe('${r.id}')"><svg class="icon icon-sm"><use href="#icon-trash"/></svg> Supprimer</button>
                    </div>
                </div>`;
            }
            return html;
        }

        // ============================================
        // SWIPE MOBILE
        // ============================================
        function setupSwipe() {
            document.querySelectorAll('.recipe-compact-wrapper').forEach(wrapper => {
                const card = wrapper.querySelector('.recipe-compact');
                let startX = 0, currentX = 0, isSwiping = false;
                
                card.addEventListener('touchstart', e => { startX = e.touches[0].clientX; isSwiping = true; card.style.transition = 'none'; }, { passive: true });
                card.addEventListener('touchmove', e => {
                    if (!isSwiping) return;
                    currentX = e.touches[0].clientX;
                    let diff = startX - currentX;
                    if (diff > 0) card.style.transform = `translateX(${Math.max(-140, -diff)}px)`;
                    else card.style.transform = `translateX(${Math.min(0, -diff)}px)`;
                }, { passive: true });
                card.addEventListener('touchend', e => {
                    isSwiping = false;
                    card.style.transition = 'transform 0.3s ease';
                    let diff = startX - currentX;
                    if (diff > 70) card.classList.add('swiped');
                    else { card.classList.remove('swiped'); card.style.transform = ''; }
                });
                document.addEventListener('touchstart', e => {
                    if (!wrapper.contains(e.target) && card.classList.contains('swiped')) {
                        card.classList.remove('swiped'); card.style.transform = '';
                    }
                });
            });
        }
        
        function toggleExp(id) {
            if (currentView === 'detailed') return; // En mode d√©taill√©, tout est d√©j√† ouvert
            expandedRecipeId = expandedRecipeId === id ? null : id;
            renderRecipes();
        }
        function setView(v) {
            currentView = v;
            if (v === 'compact') expandedRecipeId = null; // Reset seulement en mode compact
            document.querySelectorAll('.view-toggle button').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(v)));
            renderRecipes();
        }
        function setSort(s) { currentSort = s; document.querySelectorAll('.sort-toggle button').forEach(b => b.classList.toggle('active', (s === 'alpha' && b.textContent.includes('A-Z')) || (s === 'usage' && b.textContent.includes('Usage')))); renderRecipes(); }
        function toggleSelection(id) { selectedRecipes.has(id) ? selectedRecipes.delete(id) : selectedRecipes.add(id); updateStats(); updateButtonStates(); renderRecipes(); }
        function clearSelection() { selectedRecipes.clear(); updateStats(); updateButtonStates(); renderRecipes(); }

        // ============================================
        // FORM
        // ============================================
        function resetForm() {
            editingRecipeId = null;
            document.getElementById('recipeName').value = '';
            currentIngredients = [];
            currentCriteriaList = [];
            renderFormTags();
            document.getElementById('formTitle').textContent = 'Nouvelle recette';
        }
        function renderFormTags() {
            document.getElementById('ingredientTags').innerHTML = currentIngredients.map((t, i) => `<div class="tag"><span>${t}</span><span class="tag-remove" onclick="removeIngredient(${i})">‚úï</span></div>`).join('');
            document.getElementById('criteriaTags').innerHTML = currentCriteriaList.map((t, i) => `<div class="tag"><span>${t}</span><span class="tag-remove" onclick="removeCriteria(${i})">‚úï</span></div>`).join('');
        }
        function addIngredient(v) { v = v.trim(); if (v && !currentIngredients.includes(v)) { currentIngredients.unshift(v); renderFormTags(); } }
        function removeIngredient(i) { currentIngredients.splice(i, 1); renderFormTags(); }
        function addCriteria(v) { v = v.trim(); if (v && !currentCriteriaList.includes(v)) { currentCriteriaList.unshift(v); renderFormTags(); } }
        function removeCriteria(i) { currentCriteriaList.splice(i, 1); renderFormTags(); }
        
        function editRecipe(id) {
            const r = recipes.find(x => x.id === id);
            if (!r) return;
            editingRecipeId = id;
            document.getElementById('recipeName').value = r.name;
            currentIngredients = [...r.ingredients];
            currentCriteriaList = [...r.criteria];
            renderFormTags();
            document.getElementById('formTitle').textContent = 'Modifier la recette';
            openPanel('addPanel');
            document.getElementById('addPanel').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // SUPABASE CRUD
        // ============================================
        async function saveRecipe() {
            const name = document.getElementById('recipeName').value.trim();
            if (!name || !currentIngredients.length) { alert('Nom et ingr√©dients requis'); return; }

            try {
                setSyncStatus('syncing');
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                // V√©rifier que la session est valide
                if (!session?.user?.id) {
                    alert('Session expir√©e. Veuillez vous reconnecter.');
                    setSyncStatus('error');
                    return;
                }
                
                const recipeData = {
                    user_id: session.user.id,
                    name,
                    ingredients: currentIngredients,
                    double_portion: false,
                    criteria: currentCriteriaList,
                    usage_count: 0,
                    favorite: false
                };

                if (editingRecipeId) {
                    const existing = recipes.find(r => r.id === editingRecipeId);
                    if (existing) { recipeData.usage_count = existing.usageCount; recipeData.favorite = existing.favorite; }
                    const { error } = await supabaseClient.from('recipes').update(recipeData).eq('id', editingRecipeId);
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient.from('recipes').insert([recipeData]);
                    if (error) throw error;
                }
                
                resetForm();
                closePanel('addPanel');
                await loadRecipes();
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
                alert('Erreur lors de la sauvegarde');
            }
        }

        async function deleteRecipe(id) {
            if (!confirm('Supprimer cette recette ?')) return;
            try {
                setSyncStatus('syncing');
                const { error } = await supabaseClient.from('recipes').delete().eq('id', id);
                if (error) throw error;
                await loadRecipes();
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
            }
        }

        async function toggleFavorite(id) {
            try {
                setSyncStatus('syncing');
                const recipe = recipes.find(r => r.id === id);
                if (!recipe) return;
                const { error } = await supabaseClient.from('recipes').update({ favorite: !recipe.favorite }).eq('id', id);
                if (error) throw error;
                await loadRecipes();
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
            }
        }

        async function incrementUsage(id) {
            try {
                const recipe = recipes.find(r => r.id === id);
                if (!recipe) return;
                await supabaseClient.from('recipes').update({ usage_count: recipe.usageCount + 1 }).eq('id', id);
            } catch (error) {
                console.error('Erreur usage:', error);
            }
        }

        // ============================================
        // FILTERS
        // ============================================
        function addFilterIngredient(n) { n = n.trim(); if (!n || filterIngredientsList.some(f => f.name.toLowerCase() === n.toLowerCase())) return; filterIngredientsList.push({ name: n, mode: 'include' }); renderFilterTags(); renderRecipes(); }
        function addFilterCriteria(n) { n = n.trim(); if (!n || filterCriteriaList.some(f => f.name.toLowerCase() === n.toLowerCase())) return; filterCriteriaList.push({ name: n, mode: 'include' }); renderFilterTags(); renderRecipes(); }
        function renderFilterTags() {
            document.getElementById('filterIngredientsTags').innerHTML = filterIngredientsList.map((f, i) => `<div class="tag ${f.mode}"><span onclick="filterIngredientsList[${i}].mode=filterIngredientsList[${i}].mode==='include'?'exclude':'include';renderFilterTags();renderRecipes()" style="cursor:pointer">${f.mode === 'include' ? '‚úì' : '‚úó'} ${f.name}</span><span class="tag-remove" onclick="filterIngredientsList.splice(${i},1);renderFilterTags();renderRecipes()">‚úï</span></div>`).join('');
            document.getElementById('filterCriteriaTags').innerHTML = filterCriteriaList.map((f, i) => `<div class="tag ${f.mode}"><span onclick="filterCriteriaList[${i}].mode=filterCriteriaList[${i}].mode==='include'?'exclude':'include';renderFilterTags();renderRecipes()" style="cursor:pointer">${f.mode === 'include' ? '‚úì' : '‚úó'} ${f.name}</span><span class="tag-remove" onclick="filterCriteriaList.splice(${i},1);renderFilterTags();renderRecipes()">‚úï</span></div>`).join('');
        }
        function toggleFavoritesFilter() {
            showOnlyFavorites = !showOnlyFavorites;
            const b = document.getElementById('favoritesBtn');
            b.classList.toggle('active', showOnlyFavorites);
            renderRecipes();
        }
        function resetFilters() {
            filterIngredientsList = [];
            filterCriteriaList = [];
            showOnlyFavorites = false;
            randomModeIds = null; // V7: Reset random mode
            document.getElementById('searchBox').value = '';
            document.getElementById('filterIngredients').value = '';
            document.getElementById('filterCriteria').value = '';
            document.getElementById('randomModeBanner').classList.remove('show'); // V7
            const b = document.getElementById('favoritesBtn');
            b.classList.remove('active'); // V7: For quick-action-btn style
            renderFilterTags();
            renderRecipes();
        }

        // ============================================
        // RANDOMIZER
        // ============================================
        function changeRandomCount(delta) {
            const input = document.getElementById('randomCount');
            input.value = Math.max(1, Math.min(10, (parseInt(input.value) || 5) + delta));
        }
        function randomize() {
            const count = parseInt(document.getElementById('randomCount').value) || 5;
            
            // Utilise getFilteredRecipes mais SANS le mode random (on veut tous les candidats)
            let filtered = getFilteredRecipes({ includeRandomMode: false });
            
            if (!filtered.length) { alert('Aucune recette ne correspond aux filtres !'); return; }
            
            const shuffled = [...filtered].sort(() => Math.random() - 0.5);
            const picked = shuffled.slice(0, Math.min(count, filtered.length));
            
            // V7: Activer le mode random
            randomModeIds = new Set(picked.map(r => r.id));
            selectedRecipes.clear();
            picked.forEach(r => selectedRecipes.add(r.id));
            
            document.getElementById('randomModeBanner').classList.add('show');
            document.getElementById('randomModeCount').textContent = picked.length;
            
            closePanel('randomPanel');
            updateStats();
            updateButtonStates();
            renderRecipes();
        }

        // ============================================
        // SHOPPING LIST
        // ============================================
        async function addToShoppingList() {
            for (const id of selectedRecipes) {
                const r = recipes.find(x => x.id === id);
                if (r && !currentShoppingRecipes.has(id)) {
                    currentShoppingRecipes.add(id);
                    r.ingredients.forEach(i => { currentShoppingList[i] = (currentShoppingList[i] || 0) + 1; });
                    await incrementUsage(id);
                    r.usageCount++;
                }
            }
            shoppingOrder = Object.entries(currentShoppingList).sort((a, b) => b[1] - a[1]).map(e => e[0]);
            updateListTitle();
            renderShoppingList();
            renderShoppingRecipes();
            document.getElementById('shoppingActions').style.display = 'flex';
            document.getElementById('shoppingRecipes').style.display = 'block';
            selectedRecipes.clear();
            updateStats();
            updateButtonStates();
            renderRecipes();
            if (isMobile) switchTab('shopping');
        }
        
        function updateListTitle() {
            const d = new Date();
            const months = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
            document.getElementById('listTitle').textContent = `${d.getDate()} ${months[d.getMonth()]} ‚Ä¢ ${currentShoppingRecipes.size} recette${currentShoppingRecipes.size > 1 ? 's' : ''}`;
            document.getElementById('listTitleContainer').style.display = currentShoppingRecipes.size ? 'block' : 'none';
        }
        
        function renderShoppingList() {
            const c = document.getElementById('shoppingList');
            if (!shoppingOrder.length) {
                c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõí</div><p>S√©lectionnez des recettes puis g√©n√©rez votre liste</p></div>';
                document.getElementById('shoppingActions').style.display = 'none';
                document.getElementById('shoppingRecipes').style.display = 'none';
                document.getElementById('listTitleContainer').style.display = 'none';
                return;
            }

            // Grouper par cat√©gorie
            const grouped = { frais: [], sec: [], congele: [], nonclasse: [] };
            shoppingOrder.forEach((name, idx) => {
                const cat = getIngredientCategory(name);
                grouped[cat].push({ name, idx });
            });

            let html = '';
            let globalIdx = 0;
            CATEGORY_ORDER.forEach(cat => {
                const items = grouped[cat];
                if (!items.length) return;

                const info = CATEGORY_LABELS[cat];
                html += `<div class="shopping-category">
                    <div class="shopping-category-header cat-${cat}">
                        <span>${info.icon}</span>
                        <span>${info.name}</span>
                        <span style="margin-left: auto; opacity: 0.7; font-size: 0.85em;">${items.length} article${items.length > 1 ? 's' : ''}</span>
                    </div>`;

                items.forEach(item => {
                    const q = currentShoppingList[item.name] || 0;
                    html += `<div class="shopping-item ${q === 0 ? 'zero' : ''}" draggable="true" data-name="${item.name}" data-idx="${globalIdx}">
                        <div class="drag-handle"><svg class="icon"><use href="#icon-grip"/></svg></div>
                        <span class="shopping-item-name">${item.name}</span>
                        <div class="shopping-item-controls">
                            <button class="qty-btn minus" onclick="changeQty('${item.name.replace(/'/g, "\\'")}',-1)">‚àí</button>
                            <span class="shopping-item-count">√ó${q}</span>
                            <button class="qty-btn plus" onclick="changeQty('${item.name.replace(/'/g, "\\'")}',1)">+</button>
                        </div>
                    </div>`;
                    globalIdx++;
                });

                html += '</div>';
            });

            c.innerHTML = html;
            setupDragDrop();
        }
        
        // ============================================
        // DRAG & DROP
        // ============================================
        let draggedItem = null, draggedIdx = null;
        
        function setupDragDrop() {
            document.querySelectorAll('.shopping-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('drop', handleDrop);
                
                // Mobile touch
                const handle = item.querySelector('.drag-handle');
                let touchStartY = 0, isDragging = false, placeholder = null;
                
                handle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    isDragging = true;
                    draggedItem = item;
                    draggedIdx = parseInt(item.dataset.idx);
                    touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                    placeholder = document.createElement('div');
                    placeholder.className = 'drop-indicator visible';
                }, { passive: false });
                
                handle.addEventListener('touchmove', function(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    const touchCurrentY = e.touches[0].clientY;
                    const diff = touchCurrentY - touchStartY;
                    item.style.transform = `translateY(${diff}px)`;
                    item.style.zIndex = '100';
                    
                    const allItems = [...document.querySelectorAll('.shopping-item:not(.dragging)')];
                    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                    
                    for (const other of allItems) {
                        const rect = other.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (touchCurrentY < midY) {
                            other.parentNode.insertBefore(placeholder, other);
                            break;
                        } else {
                            other.parentNode.insertBefore(placeholder, other.nextSibling);
                        }
                    }
                }, { passive: false });
                
                handle.addEventListener('touchend', function() {
                    if (!isDragging) return;
                    isDragging = false;
                    item.classList.remove('dragging');
                    item.style.transform = '';
                    item.style.zIndex = '';
                    
                    if (placeholder && placeholder.parentNode) {
                        const allItems = [...document.querySelectorAll('.shopping-item, .drop-indicator')];
                        const newIdx = allItems.indexOf(placeholder);
                        const oldIdx = draggedIdx;
                        if (newIdx !== oldIdx && newIdx >= 0) {
                            const movedName = shoppingOrder[oldIdx];
                            shoppingOrder.splice(oldIdx, 1);
                            shoppingOrder.splice(newIdx > oldIdx ? newIdx - 1 : newIdx, 0, movedName);
                        }
                        placeholder.remove();
                    }
                    renderShoppingList();
                });
            });
        }
        
        function handleDragStart(e) {
            draggedItem = this;
            draggedIdx = parseInt(this.dataset.idx);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        }
        function handleDragEnter(e) {
            e.preventDefault();
            if (this === draggedItem) return;
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator visible';
            const rect = this.getBoundingClientRect();
            if (e.clientY < rect.top + rect.height / 2) this.parentNode.insertBefore(indicator, this);
            else this.parentNode.insertBefore(indicator, this.nextSibling);
        }
        function handleDrop(e) {
            e.preventDefault();
            if (this === draggedItem) return;
            const indicator = document.querySelector('.drop-indicator');
            if (indicator) {
                const allItems = [...document.querySelectorAll('.shopping-item, .drop-indicator')];
                const newIdx = allItems.indexOf(indicator);
                if (newIdx !== draggedIdx && newIdx >= 0) {
                    const movedName = shoppingOrder[draggedIdx];
                    shoppingOrder.splice(draggedIdx, 1);
                    shoppingOrder.splice(newIdx > draggedIdx ? newIdx - 1 : newIdx, 0, movedName);
                }
                indicator.remove();
            }
            renderShoppingList();
        }
        
        function changeQty(n, d) { if (currentShoppingList[n] !== undefined) { currentShoppingList[n] = Math.max(0, currentShoppingList[n] + d); renderShoppingList(); } }
        function renderShoppingRecipes() {
            document.getElementById('shoppingRecipesList').innerHTML = Array.from(currentShoppingRecipes).map(id => {
                const r = recipes.find(x => x.id === id);
                return r ? `<div class="shopping-recipe-item"><span>${r.name}</span><button class="remove-recipe-btn" onclick="removeFromList('${id}')">Retirer</button></div>` : '';
            }).join('');
        }
        function removeFromList(id) {
            const r = recipes.find(x => x.id === id);
            if (r && currentShoppingRecipes.has(id)) {
                r.ingredients.forEach(i => { if (currentShoppingList[i]) { currentShoppingList[i]--; if (currentShoppingList[i] <= 0) { delete currentShoppingList[i]; shoppingOrder = shoppingOrder.filter(n => n !== i); } } });
                currentShoppingRecipes.delete(id);
                updateListTitle();
                renderShoppingList();
                renderShoppingRecipes();
                updateButtonStates();
            }
        }
        function clearShoppingList() {
            if (!shoppingOrder.length) return;
            if (!confirm('Vider toute la liste ?')) return;
            currentShoppingList = {};
            currentShoppingRecipes.clear();
            shoppingOrder = [];
            renderShoppingList();
            renderShoppingRecipes();
            updateListTitle();
            updateButtonStates();
        }
        function copyShoppingList() {
            // Grouper par cat√©gorie pour la copie
            const grouped = { frais: [], sec: [], congele: [], nonclasse: [] };
            shoppingOrder.forEach(name => {
                const q = currentShoppingList[name];
                if (q > 0) {
                    const cat = getIngredientCategory(name);
                    grouped[cat].push({ name, q });
                }
            });

            let t = '';
            CATEGORY_ORDER.forEach(cat => {
                const items = grouped[cat];
                if (!items.length) return;
                const info = CATEGORY_LABELS[cat];
                t += `\n${info.icon} ${info.name.toUpperCase()}\n`;
                items.forEach(item => {
                    t += `‚òê ${item.name} √ó${item.q}\n`;
                });
            });

            navigator.clipboard.writeText(t.trim()).then(() => alert('Liste copi√©e !'));
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================
        document.getElementById('csvImport').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const text = await file.text();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) { alert('Fichier CSV vide ou invalide'); return; }
            
            try {
                setSyncStatus('syncing');
                const { data: { session } } = await supabaseClient.auth.getSession();
                const toImport = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 2 && parts[0].trim()) {
                        toImport.push({
                            user_id: session.user.id,
                            name: parts[0].trim(),
                            ingredients: parts[1].split(';').map(s => s.trim()).filter(s => s),
                            double_portion: parts[2] ? parts[2].trim().toLowerCase() === 'oui' : false,
                            criteria: parts[3] ? parts[3].split(';').map(s => s.trim()).filter(s => s) : [],
                            usage_count: parts[4] ? parseInt(parts[4]) || 0 : 0,
                            favorite: parts[5] ? parts[5].trim().toLowerCase() === 'oui' : false
                        });
                    }
                }
                
                if (!toImport.length) { alert('Aucune recette valide'); return; }
                const { error } = await supabaseClient.from('recipes').insert(toImport);
                if (error) throw error;
                
                alert(`‚úÖ ${toImport.length} recettes import√©es !`);
                await loadRecipes();
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
                alert('Erreur lors de l\'import');
            }
            e.target.value = '';
        });

        function exportCSV() {
            if (!recipes.length) { alert('Aucune recette √† exporter'); return; }
            let csv = 'Nom de la recette,Ingr√©dients,Double portion,Crit√®res,Utilisations,Favori\n';
            recipes.forEach(r => {
                csv += [r.name, r.ingredients.join(';'), r.double ? 'oui' : 'non', r.criteria.join(';'), r.usageCount, r.favorite ? 'oui' : 'non'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `recettes_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // UI HELPERS & PANELS
        // ============================================
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const btn = document.querySelector(`[data-panel="${panelId}"]`);
            const isOpen = panel.classList.contains('show');
            
            if (isOpen) {
                closePanel(panelId);
            } else {
                closeAllPanels();
                openPanel(panelId);
            }
        }
        
        function openPanel(panelId) {
            document.getElementById(panelId)?.classList.add('show');
            document.querySelector(`[data-panel="${panelId}"]`)?.classList.add('active');
            if (panelId === 'addPanel') {
                setTimeout(() => document.getElementById('recipeName')?.focus(), 100);
            }
        }
        
        function closePanel(panelId) {
            document.getElementById(panelId)?.classList.remove('show');
            document.querySelector(`[data-panel="${panelId}"]`)?.classList.remove('active');
            if (panelId === 'addPanel') resetForm();
        }
        
        function closeAllPanels() {
            ['addPanel', 'randomPanel', 'filterPanel'].forEach(id => {
                document.getElementById(id)?.classList.remove('show');
                document.querySelector(`[data-panel="${id}"]`)?.classList.remove('active');
            });
        }
        
        function toggleOptionsMenu() { document.getElementById('optionsMenu').classList.toggle('show'); }
        function closeOptionsMenu() { document.getElementById('optionsMenu').classList.remove('show'); }
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.mobile-tabs button').forEach(btn => btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab === 'recipes' ? 'recettes' : 'liste')));
            document.getElementById('recipesSection').classList.toggle('hidden-mobile', tab !== 'recipes');
            document.getElementById('recipesSection').classList.toggle('show-mobile', tab === 'recipes');
            document.getElementById('shoppingSection').classList.toggle('hidden-mobile', tab !== 'shopping');
            document.getElementById('shoppingSection').classList.toggle('show-mobile', tab === 'shopping');
        }

        // ============================================
        // V7: SELECT ALL / RANDOM MODE / TOP CRITERIA
        // ============================================
        let randomModeIds = null;
        let visibleRecipeIds = [];
        
        function toggleSelectAll() {
            const allSelected = visibleRecipeIds.length > 0 && visibleRecipeIds.every(id => selectedRecipes.has(id));
            if (allSelected) {
                visibleRecipeIds.forEach(id => selectedRecipes.delete(id));
            } else {
                visibleRecipeIds.forEach(id => selectedRecipes.add(id));
            }
            updateStats();
            updateButtonStates();
            renderRecipes();
        }
        
        function exitRandomMode() {
            randomModeIds = null;
            document.getElementById('randomModeBanner').classList.remove('show');
            renderRecipes();
        }
        
        function renderTopCriteria() {
            const critCounts = {};
            recipes.forEach(r => r.criteria.forEach(c => { critCounts[c] = (critCounts[c] || 0) + 1; }));
            const sorted = Object.entries(critCounts).sort((a, b) => b[1] - a[1]);
            const colors = ['--crit-1','--crit-2','--crit-3','--crit-4','--crit-5','--crit-6','--crit-7','--crit-8','--crit-9','--crit-10'];
            
            // Top 10 pour le formulaire d'ajout
            const top10 = sorted.slice(0, 10);
            document.getElementById('topCriteria').innerHTML = top10.map(([name, count], i) => 
                `<button class="criteria-chip" style="background: var(${colors[i % 10]})" onclick="addCriteriaFromChip('${name.replace(/'/g, "\\'")}')">${name} <span class="count">${count}</span></button>`
            ).join('');
            
            // Top 8 pour les filtres
            const top8 = sorted.slice(0, 8);
            document.getElementById('topCriteriaFilter').innerHTML = top8.map(([name, count], i) => 
                `<button class="criteria-chip" style="background: var(${colors[i % 10]})" onclick="addFilterCriteriaFromChip('${name.replace(/'/g, "\\'")}')">${name} <span class="count">${count}</span></button>`
            ).join('');
        }
        
        function addCriteriaFromChip(name) {
            if (!currentCriteriaList.includes(name)) {
                currentCriteriaList.unshift(name);
                renderFormTags();
            }
        }
        
        function addFilterCriteriaFromChip(name) {
            if (!filterCriteriaList.some(f => f.name.toLowerCase() === name.toLowerCase())) {
                filterCriteriaList.push({ name: name, mode: 'include' });
                renderFilterTags();
                renderRecipes();
            }
        }

        // ============================================
        // BACKOFFICE CATEGORIES (Supabase)
        // ============================================
        const CATEGORY_ORDER = ['frais', 'sec', 'congele', 'nonclasse'];
        const CATEGORY_LABELS = {
            frais: { icon: 'ü•¨', name: 'Frais', desc: 'Fruits, l√©gumes, viandes, produits laitiers...' },
            sec: { icon: 'ü•´', name: 'Sec', desc: 'P√¢tes, riz, conserves, √©pices...' },
            congele: { icon: 'üßä', name: 'Congel√©', desc: 'Produits surgel√©s' },
            nonclasse: { icon: 'üì¶', name: 'Non class√©', desc: 'Ingr√©dients pas encore class√©s' }
        };
        let ingredientCategories = {};
        let selectedIngredientsBO = new Set();

        async function loadIngredientCategories() {
            try {
                const { data, error } = await supabaseClient
                    .from('ingredient_categories')
                    .select('ingredient_name, category');

                if (error) throw error;

                ingredientCategories = {};
                (data || []).forEach(row => {
                    ingredientCategories[row.ingredient_name] = row.category;
                });
            } catch (e) {
                console.error('Erreur chargement cat√©gories:', e);
                // Fallback localStorage si table n'existe pas encore
                try {
                    const saved = localStorage.getItem('ingredientCategories');
                    ingredientCategories = saved ? JSON.parse(saved) : {};
                } catch (e2) {
                    ingredientCategories = {};
                }
            }
        }

        async function saveIngredientCategory(ingredientName, category) {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session?.user?.id) return;

                const { error } = await supabaseClient
                    .from('ingredient_categories')
                    .upsert({
                        user_id: session.user.id,
                        ingredient_name: ingredientName,
                        category: category
                    }, {
                        onConflict: 'user_id,ingredient_name'
                    });

                if (error) throw error;
            } catch (e) {
                console.error('Erreur sauvegarde cat√©gorie:', e);
                // Fallback localStorage
                localStorage.setItem('ingredientCategories', JSON.stringify(ingredientCategories));
            }
        }

        function getIngredientCategory(name) {
            const nameNorm = normalize(name);
            for (const [ing, cat] of Object.entries(ingredientCategories)) {
                if (normalize(ing) === nameNorm) return cat;
            }
            return 'nonclasse';
        }

        function openBackoffice() {
            selectedIngredientsBO.clear();
            document.getElementById('backofficeModal').classList.add('show');
            renderBackoffice();
        }

        function closeBackoffice() {
            document.getElementById('backofficeModal').classList.remove('show');
        }

        function renderBackoffice() {
            const content = document.getElementById('backofficeContent');
            const ingredients = Array.from(allIngredients).sort((a, b) => a.localeCompare(b));

            // Grouper par cat√©gorie
            const grouped = { frais: [], sec: [], congele: [], nonclasse: [] };
            ingredients.forEach(ing => {
                const cat = getIngredientCategory(ing);
                grouped[cat].push(ing);
            });

            let html = '';
            CATEGORY_ORDER.forEach(cat => {
                const info = CATEGORY_LABELS[cat];
                const items = grouped[cat];

                html += `<div class="category-section">
                    <div class="category-header cat-${cat}">
                        <span class="category-icon">${info.icon}</span>
                        <span>${info.name}</span>
                        <span class="category-count">${items.length}</span>
                    </div>
                    <div class="ingredients-grid">
                        ${items.length ? items.map(ing => `
                            <div class="ingredient-chip ${selectedIngredientsBO.has(ing) ? 'selected' : ''}" onclick="toggleIngredientBO('${ing.replace(/'/g, "\\'")}')">
                                <span class="chip-category cat-${cat}"></span>
                                ${ing}
                            </div>
                        `).join('') : '<span style="color: var(--text-light); font-style: italic; padding: 10px;">Aucun ingr√©dient</span>'}
                    </div>
                </div>`;
            });

            content.innerHTML = html;
            updateCategoryActions();
        }

        function toggleIngredientBO(name) {
            if (selectedIngredientsBO.has(name)) {
                selectedIngredientsBO.delete(name);
            } else {
                selectedIngredientsBO.add(name);
            }
            renderBackoffice();
        }

        function updateCategoryActions() {
            const actionsDiv = document.getElementById('categoryActions');
            const countSpan = document.getElementById('selectedCountBO');
            const count = selectedIngredientsBO.size;

            actionsDiv.style.display = count > 0 ? 'flex' : 'none';
            countSpan.textContent = count;
        }

        async function assignCategory(category) {
            setSyncStatus('syncing');
            const promises = [];

            selectedIngredientsBO.forEach(ing => {
                ingredientCategories[ing] = category;
                promises.push(saveIngredientCategory(ing, category));
            });

            await Promise.all(promises);
            setSyncStatus('synced');
            selectedIngredientsBO.clear();
            renderBackoffice();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('searchBox').addEventListener('input', renderRecipes);
        document.addEventListener('click', e => { if (!e.target.closest('.header-right')) closeOptionsMenu(); });

        // ============================================
        // INIT
        // ============================================
        (async () => {
            setupAutocomplete();
            if (await checkAuth()) {
                await loadIngredientCategories();
                await loadRecipes();
            }
        })();
    </script>
</body>
</html>
