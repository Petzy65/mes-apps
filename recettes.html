<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Recettes</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8B7EC8;
            --primary-dark: #6B5EA8;
            --primary-light: #E8E4F4;
            --accent: #F5A673;
            --accent-light: #FFE4D1;
            --success: #6AAF8B;
            --danger: #E07B7B;
            --warning: #F5C56D;
            --text-dark: #3D3554;
            --text-medium: #5D5475;
            --text-light: #8B85A0;
            --surface: #FAF8FF;
            --surface-alt: #F3F0FA;
            --border: #DDD8E8;
            --white: #FFFFFF;
            /* Cama√Øeu pour les crit√®res */
            --crit-1: #8B7EC8;
            --crit-2: #9D8FD4;
            --crit-3: #AEA0DF;
            --crit-4: #BFB2E9;
            --crit-5: #D0C4F2;
            --crit-6: #F5A673;
            --crit-7: #F7B68A;
            --crit-8: #F9C6A1;
            --crit-9: #FBD6B8;
            --crit-10: #FDE6CF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%); min-height: 100vh; padding: 20px; padding-bottom: 100px; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--white); border-radius: 20px; box-shadow: 0 20px 60px rgba(139, 126, 200, 0.25); overflow: hidden; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: var(--white); padding: 15px 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9em; }
        .sync-status { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.15); border-radius: 20px; font-size: 0.85em; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; }
        .sync-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-right { display: flex; align-items: center; gap: 10px; position: relative; }
        .user-email { font-size: 0.85em; opacity: 0.9; }
        .header-btn { padding: 6px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-family: 'Montserrat', sans-serif; }
        
        /* Options Menu */
        .options-menu { position: absolute; top: 100%; right: 0; background: var(--white); border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 220px; display: none; z-index: 200; overflow: hidden; margin-top: 5px; }
        .options-menu.show { display: block; }
        .options-menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; color: var(--text-dark); font-size: 0.9em; transition: background 0.2s; }
        .options-menu-item:hover { background: var(--surface-alt); }
        .options-menu-item.danger { color: var(--danger); }
        .options-menu-item input[type="file"] { display: none; }

        /* Mobile Tabs */
        .mobile-tabs { display: none; background: var(--primary-dark); }
        .mobile-tabs button { flex: 1; padding: 15px; background: transparent; border: none; color: rgba(255,255,255,0.7); font-size: 1em; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif; }
        .mobile-tabs button.active { background: rgba(255,255,255,0.1); color: white; border-bottom: 3px solid var(--accent); }

        /* Main Content */
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 30px; }
        .section { background: var(--surface); padding: 20px; border-radius: 15px; }

        /* Buttons */
        button, .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; background: var(--primary); color: var(--white); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 600; border: none; font-family: 'Montserrat', sans-serif; font-size: 0.9em; min-height: 40px; }
        button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        button:disabled { background: var(--border); color: var(--text-light); cursor: not-allowed; transform: none; }
        .btn-small { padding: 6px 12px; font-size: 0.8em; min-height: 32px; }
        .btn-icon { padding: 8px; min-height: 36px; min-width: 36px; border-radius: 8px; }
        .btn-success { background: var(--success); }
        .btn-success:hover:not(:disabled) { background: #5A9A7A; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover:not(:disabled) { background: #C96A6A; }
        .btn-warning { background: var(--warning); color: var(--text-dark); }
        .btn-accent { background: var(--accent); color: var(--white); }
        .btn-accent:hover:not(:disabled) { background: #E09560; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover:not(:disabled) { background: var(--primary-light); }

        /* SVG Icons */
        .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 22px; height: 22px; }

        /* Stats */
        .stats-bar { display: flex; gap: 15px; padding: 10px 14px; background: var(--white); border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--border); flex-wrap: wrap; align-items: center; }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .stat-number { font-size: 1.3em; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--text-light); font-size: 0.8em; }

        /* === QUICK ACTIONS BAR === */
        .quick-actions { display: flex; gap: 8px; margin-bottom: 15px; }
        .quick-action-btn { position: relative; width: 44px; height: 44px; border-radius: 10px; background: var(--white); border: 2px solid var(--border); color: var(--primary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .quick-action-btn:hover { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .quick-action-btn.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .quick-action-btn .icon { width: 20px; height: 20px; }
        
        /* Tooltip */
        .quick-action-btn::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--text-dark); color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.75em; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; margin-bottom: 5px; }
        .quick-action-btn:hover::after { opacity: 1; }

        /* Panels */
        .action-panel { display: none; background: var(--white); border-radius: 10px; border: 2px solid var(--border); margin-bottom: 15px; overflow: hidden; animation: slideDown 0.3s ease; }
        .action-panel.show { display: block; }
        @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 500px; } }
        .action-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--surface-alt); border-bottom: 1px solid var(--border); }
        .action-panel-title { font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .action-panel-close { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 4px; }
        .action-panel-body { padding: 15px; }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95em; font-family: 'Montserrat', sans-serif; background: var(--white); color: var(--text-dark); transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }

        /* Tags */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 40px; padding: 10px; background: var(--surface-alt); border-radius: 8px; border: 2px dashed var(--border); }
        .tags-container:empty::before { content: attr(data-placeholder); color: var(--text-light); font-style: italic; font-size: 0.9em; }
        .tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary); color: var(--white); border-radius: 20px; font-size: 0.85em; font-weight: 500; animation: tagPop 0.2s ease-out; }
        .tag-remove { cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .tag-remove:hover { opacity: 1; }
        .tag.include { background: var(--success); }
        .tag.exclude { background: var(--danger); }
        @keyframes tagPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hint { font-size: 0.8em; color: var(--text-light); margin-top: 5px; font-style: italic; }

        /* Top Criteria Chips */
        .top-criteria { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .criteria-chip { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; color: var(--white); }
        .criteria-chip:hover { transform: scale(1.05); filter: brightness(1.1); }
        .criteria-chip .count { background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px; font-size: 0.9em; }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border: 2px solid var(--primary); border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--surface-alt); font-size: 0.9em; transition: background 0.2s; }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover { background: var(--surface-alt); }
        .autocomplete-item.selected { background: var(--primary); color: var(--white); }
        .autocomplete-highlight { font-weight: 700; color: var(--accent); }
        .autocomplete-item.selected .autocomplete-highlight { color: var(--warning); }

        /* Search & List Controls */
        .search-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .search-box { flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9em; font-family: 'Montserrat', sans-serif; background: var(--white); }
        .search-box:focus { outline: none; border-color: var(--primary); }
        
        .list-controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
        .control-group { display: flex; background: var(--surface-alt); border-radius: 6px; overflow: hidden; border: 2px solid var(--border); }
        .control-group button { padding: 6px 12px; background: transparent; border: none; color: var(--text-medium); font-weight: 600; cursor: pointer; min-height: auto; font-size: 0.8em; font-family: 'Montserrat', sans-serif; }
        .control-group button:hover { background: var(--primary-light); transform: none; }
        .control-group button.active { background: var(--primary); color: var(--white); }
        
        .select-all-btn { padding: 6px 12px; font-size: 0.8em; min-height: auto; }

        /* Recipe List */
        .recipe-list { max-height: 450px; overflow-y: auto; overflow-x: hidden; }
        
        /* Recipe Compact */
        .recipe-compact-wrapper { position: relative; overflow: hidden; margin-bottom: 6px; border-radius: 8px; }
        .recipe-compact { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--white); border-radius: 8px; border: 2px solid var(--border); transition: transform 0.3s ease, border-color 0.2s; position: relative; z-index: 2; }
        .recipe-compact:hover { border-color: var(--accent); }
        .recipe-compact.selected { background: var(--primary-light); border-color: var(--primary); }
        .recipe-compact.favorite { border-left: 4px solid var(--warning); }
        .recipe-compact.swiped { transform: translateX(-140px); }
        
        /* Swipe Actions */
        .swipe-actions { position: absolute; right: 0; top: 0; bottom: 0; width: 140px; display: flex; align-items: stretch; z-index: 1; border-radius: 0 8px 8px 0; overflow: hidden; }
        .swipe-action { flex: 1; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .swipe-action.fav { background: var(--warning); color: var(--text-dark); }
        .swipe-action.edit { background: var(--primary); color: var(--white); }
        .swipe-action.delete { background: var(--danger); color: var(--white); }

        .recipe-checkbox-zone { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; margin: -8px; margin-right: 2px; cursor: pointer; border-radius: 6px; }
        .recipe-checkbox-zone:hover { background: var(--primary-light); }
        .recipe-compact-checkbox { width: 20px; height: 20px; border: 2px solid var(--primary); border-radius: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .recipe-compact.selected .recipe-compact-checkbox { background: var(--primary); }
        .recipe-compact-checkbox .icon { opacity: 0; color: var(--white); width: 14px; height: 14px; }
        .recipe-compact.selected .recipe-compact-checkbox .icon { opacity: 1; }
        .recipe-compact-main { flex: 1; cursor: pointer; }
        .recipe-compact-name { font-weight: 600; color: var(--text-dark); font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .recipe-compact-name .icon { color: var(--warning); width: 14px; height: 14px; fill: var(--warning); stroke: var(--warning); }
        .recipe-compact-meta { display: flex; gap: 8px; margin-top: 3px; color: var(--text-light); font-size: 0.75em; }

        /* Recipe Inline Detail */
        .recipe-inline-detail { background: var(--white); border: 2px solid var(--primary); border-top: none; border-radius: 0 0 8px 8px; margin-top: -8px; margin-bottom: 6px; padding: 12px; }
        .recipe-inline-detail-section { margin-bottom: 10px; }
        .recipe-inline-detail-section strong { color: var(--primary); font-size: 0.8em; display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .recipe-inline-detail-section p { color: var(--text-medium); font-size: 0.85em; line-height: 1.4; }
        .recipe-inline-detail-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .recipe-tag { padding: 3px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; }
        .recipe-tag.criteria { background: var(--primary-light); color: var(--primary-dark); }
        .recipe-tag.usage { background: var(--accent); color: var(--white); }
        .recipe-inline-actions { display: flex; gap: 6px; padding-top: 10px; border-top: 1px solid var(--border); }

        /* Random Only Mode Banner */
        .random-mode-banner { display: none; background: linear-gradient(135deg, var(--accent), var(--warning)); color: var(--text-dark); padding: 10px 15px; border-radius: 8px; margin-bottom: 12px; align-items: center; justify-content: space-between; }
        .random-mode-banner.show { display: flex; }
        .random-mode-banner span { font-weight: 600; font-size: 0.9em; }

        /* Shopping List */
        .shopping-list { max-height: 350px; overflow-y: auto; }
        .shopping-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--white); margin-bottom: 5px; border-radius: 6px; border: 2px solid var(--border); user-select: none; }
        .shopping-item.zero { opacity: 0.4; }
        .shopping-item.dragging { opacity: 0.5; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .drop-indicator { height: 3px; background: var(--accent); border-radius: 2px; margin: 2px 0; }
        .drag-handle { cursor: grab; color: var(--text-light); padding: 2px; display: flex; touch-action: none; }
        .shopping-item-name { flex: 1; font-weight: 500; color: var(--text-dark); font-size: 0.85em; }
        .shopping-item-controls { display: flex; align-items: center; gap: 4px; }
        .qty-btn { width: 26px; height: 26px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: var(--white); padding: 0; display: flex; align-items: center; justify-content: center; font-family: 'Montserrat', sans-serif; font-size: 0.9em; }
        .qty-btn:hover { transform: scale(1.1); }
        .qty-btn.minus { background: var(--danger); }
        .qty-btn.plus { background: var(--success); }
        .shopping-item-count { background: var(--accent); color: var(--white); padding: 3px 8px; border-radius: 8px; font-size: 0.75em; font-weight: 600; min-width: 32px; text-align: center; }
        
        .list-title { font-size: 0.95em; font-weight: 600; color: var(--primary); padding: 10px; background: var(--white); border-radius: 6px; border: 2px solid var(--primary); text-align: center; margin-bottom: 12px; }
        
        /* Collapsible Shopping Recipes */
        .shopping-recipes-collapsible { background: var(--white); border-radius: 8px; border: 2px solid var(--border); margin-top: 15px; overflow: hidden; }
        .shopping-recipes-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; cursor: pointer; transition: background 0.2s; }
        .shopping-recipes-header:hover { background: var(--surface-alt); }
        .shopping-recipes-title { font-weight: 600; color: var(--primary); font-size: 0.85em; display: flex; align-items: center; gap: 6px; }
        .shopping-recipes-arrow { transition: transform 0.3s; color: var(--text-light); font-size: 0.8em; }
        .shopping-recipes-collapsible.open .shopping-recipes-arrow { transform: rotate(180deg); }
        .shopping-recipes-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .shopping-recipes-collapsible.open .shopping-recipes-content { max-height: 300px; }
        .shopping-recipes-inner { padding: 10px 12px; border-top: 1px solid var(--border); }
        .shopping-recipe-item { display: flex; align-items: center; padding: 6px 10px; background: var(--surface-alt); border-radius: 5px; margin-bottom: 5px; font-size: 0.8em; }
        .shopping-recipe-item span { flex: 1; color: var(--text-dark); }
        .shopping-recipe-item .remove-recipe-btn { background: var(--danger); color: var(--white); border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-family: 'Montserrat', sans-serif; }

        .empty-state { text-align: center; padding: 30px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 2.5em; margin-bottom: 10px; opacity: 0.5; }
        .empty-state p { font-size: 0.9em; margin-bottom: 12px; }

        /* Action Bar */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); padding: 12px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 12px; z-index: 100; }
        .action-bar button { min-width: 130px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--white); border-radius: 15px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 20px; border-bottom: 2px solid var(--border); }
        .modal-header h3 { color: var(--text-dark); font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .modal-body { padding: 20px; color: var(--text-medium); font-size: 0.95em; line-height: 1.5; }
        .modal-footer { padding: 15px 20px; border-top: 2px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
        .modal-footer button { min-width: 100px; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; padding-bottom: 80px; }
            .main-content { grid-template-columns: 1fr; gap: 20px; padding: 15px; }
            .section { padding: 15px; }
            .mobile-tabs { display: flex; }
            .section.hidden-mobile { display: none; }
            .section.show-mobile { display: block; }
            .action-bar button { min-width: auto; flex: 1; font-size: 0.8em; padding: 10px; }
            .quick-action-btn::after { display: none; }
            .quick-actions { justify-content: center; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--surface-alt); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-left">
                    <a href="index.html" class="back-btn">‚Üê Retour</a>
                    <div class="sync-status">
                        <div class="sync-dot" id="syncDot"></div>
                        <span id="syncText">Synchronis√©</span>
                    </div>
                </div>
                <div class="header-right">
                    <span class="user-email" id="userEmail">...</span>
                    <button class="header-btn" onclick="toggleOptionsMenu()">‚öôÔ∏è</button>
                    <div class="options-menu" id="optionsMenu">
                        <label class="options-menu-item">
                            <svg class="icon icon-sm"><use href="#icon-upload"/></svg> Importer CSV
                            <input type="file" id="csvImport" accept=".csv">
                        </label>
                        <div class="options-menu-item" onclick="exportCSV(); closeOptionsMenu();">
                            <svg class="icon icon-sm"><use href="#icon-download"/></svg> Exporter CSV
                        </div>
                        <div class="options-menu-item danger" onclick="handleLogout()">
                            <svg class="icon icon-sm"><use href="#icon-logout"/></svg> D√©connexion
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="mobile-tabs">
            <button class="active" onclick="switchTab('recipes')">üìö Recettes</button>
            <button onclick="switchTab('shopping')">üõí Liste</button>
        </div>

        <div class="main-content">
            <!-- LEFT: Recipes -->
            <div class="section show-mobile" id="recipesSection">
                <div class="stats-bar">
                    <div class="stat-item"><span class="stat-number" id="totalCount">0</span><span class="stat-label">recettes</span></div>
                    <div class="stat-item"><span class="stat-number" id="selectedCount">0</span><span class="stat-label">s√©lect.</span></div>
                    <div class="stat-item"><span class="stat-number" id="favCount">0</span><span class="stat-label">favoris</span></div>
                </div>

                <!-- Quick Actions Bar -->
                <div class="quick-actions">
                    <button class="quick-action-btn" data-tooltip="Ajouter une recette" data-panel="addPanel" onclick="togglePanel('addPanel')">
                        <svg class="icon"><use href="#icon-plus"/></svg>
                    </button>
                    <button class="quick-action-btn" data-tooltip="Tirage al√©atoire" data-panel="randomPanel" onclick="togglePanel('randomPanel')">
                        <svg class="icon"><use href="#icon-shuffle"/></svg>
                    </button>
                    <button class="quick-action-btn" data-tooltip="Filtres" data-panel="filterPanel" onclick="togglePanel('filterPanel')">
                        <svg class="icon"><use href="#icon-filter"/></svg>
                    </button>
                    <button class="quick-action-btn btn-warning" data-tooltip="Favoris uniquement" id="favoritesBtn" onclick="toggleFavoritesFilter()">
                        <svg class="icon"><use href="#icon-star"/></svg>
                    </button>
                </div>

                <!-- Add Panel -->
                <div class="action-panel" id="addPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-plus"/></svg> <span id="formTitle">Nouvelle recette</span></span>
                        <button class="action-panel-close" onclick="closePanel('addPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div class="form-group">
                            <label>Nom de la recette</label>
                            <input type="text" id="recipeName" placeholder="Ex: P√¢tes carbonara">
                        </div>
                        <div class="form-group">
                            <label>Ingr√©dients</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="recipeIngredients" placeholder="Tapez puis Tab ou Entr√©e" autocomplete="off">
                                <div class="autocomplete-dropdown" id="ingredientsAutocomplete"></div>
                            </div>
                            <div class="hint">‚Üë‚Üì naviguer ‚Ä¢ Tab/Entr√©e valider ‚Ä¢ √âchap fermer</div>
                            <div class="tags-container" id="ingredientTags" data-placeholder="Les ingr√©dients appara√Ætront ici..."></div>
                        </div>
                        <div class="form-group">
                            <label>Crit√®res</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="recipeCriteria" placeholder="Ex: Rapide, Facile..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="criteriaAutocomplete"></div>
                            </div>
                            <div class="tags-container" id="criteriaTags" data-placeholder="Les crit√®res appara√Ætront ici..."></div>
                            <div class="top-criteria" id="topCriteria"></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-outline" onclick="resetForm()"><svg class="icon icon-sm"><use href="#icon-refresh"/></svg> R√©init.</button>
                            <button class="btn-success" onclick="saveRecipe()"><svg class="icon icon-sm"><use href="#icon-check"/></svg> Sauvegarder</button>
                        </div>
                    </div>
                </div>

                <!-- Random Panel -->
                <div class="action-panel" id="randomPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-shuffle"/></svg> Tirage al√©atoire</span>
                        <button class="action-panel-close" onclick="closePanel('randomPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-accent" onclick="randomize()"><svg class="icon icon-sm"><use href="#icon-shuffle"/></svg> Surprise !</button>
                            <div style="display: flex; align-items: center; background: var(--surface-alt); border-radius: 6px; border: 2px solid var(--border);">
                                <button class="btn-small" onclick="changeRandomCount(-1)" style="background: transparent; color: var(--text-dark);">‚àí</button>
                                <input type="text" id="randomCount" value="5" readonly style="width: 35px; text-align: center; border: none; background: transparent; font-weight: 600; font-family: 'Montserrat', sans-serif;">
                                <button class="btn-small" onclick="changeRandomCount(1)" style="background: transparent; color: var(--text-dark);">+</button>
                            </div>
                            <span style="color: var(--text-light); font-size: 0.8em;">recettes</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div class="action-panel" id="filterPanel">
                    <div class="action-panel-header">
                        <span class="action-panel-title"><svg class="icon icon-sm"><use href="#icon-filter"/></svg> Filtres</span>
                        <button class="action-panel-close" onclick="closePanel('filterPanel')"><svg class="icon icon-sm"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="action-panel-body">
                        <div class="form-group">
                            <label>Par ingr√©dient</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="filterIngredients" placeholder="Filtrer par ingr√©dient..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="filterIngredientsAutocomplete"></div>
                            </div>
                            <div class="hint">Vert = AVEC ‚Ä¢ Rouge = SANS</div>
                            <div class="tags-container" id="filterIngredientsTags" data-placeholder=""></div>
                        </div>
                        <div class="form-group">
                            <label>Par crit√®re</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="filterCriteria" placeholder="Filtrer par crit√®re..." autocomplete="off">
                                <div class="autocomplete-dropdown" id="filterCriteriaAutocomplete"></div>
                            </div>
                            <div class="tags-container" id="filterCriteriaTags" data-placeholder=""></div>
                        </div>
                        <button class="btn-outline btn-small" onclick="resetFilters()"><svg class="icon icon-sm"><use href="#icon-refresh"/></svg> R√©initialiser filtres</button>
                    </div>
                </div>

                <!-- Random Mode Banner -->
                <div class="random-mode-banner" id="randomModeBanner">
                    <span>üé≤ <span id="randomModeCount">0</span> recettes tir√©es</span>
                    <button class="btn-small" onclick="exitRandomMode()">Voir toutes</button>
                </div>

                <div class="search-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Rechercher...">
                </div>
                
                <div class="list-controls">
                    <div class="control-group">
                        <button class="active" onclick="setSort('alpha')">A-Z</button>
                        <button onclick="setSort('usage')">Usage</button>
                    </div>
                    <button class="select-all-btn btn-outline btn-small" id="selectAllBtn" onclick="toggleSelectAll()">‚òëÔ∏è Tout s√©lect.</button>
                </div>

                <div class="recipe-list" id="recipeList">
                    <div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>Chargement...</p></div>
                </div>
            </div>

            <!-- RIGHT: Shopping List -->
            <div class="section hidden-mobile" id="shoppingSection">
                <h2 style="color: var(--primary); font-size: 1.2em; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <svg class="icon icon-lg"><use href="#icon-cart"/></svg> Liste de courses
                </h2>
                <div id="listTitleContainer" style="display: none;"><div class="list-title" id="listTitle"></div></div>
                <div class="shopping-list" id="shoppingList">
                    <div class="empty-state"><div class="empty-state-icon">üõí</div><p>S√©lectionnez des recettes puis g√©n√©rez votre liste</p></div>
                </div>
                
                <!-- Collapsible Shopping Recipes -->
                <div class="shopping-recipes-collapsible" id="shoppingRecipesSection" style="display: none;">
                    <div class="shopping-recipes-header" onclick="toggleShoppingRecipes()">
                        <span class="shopping-recipes-title"><svg class="icon icon-sm"><use href="#icon-list"/></svg> Recettes incluses (<span id="shoppingRecipesCount">0</span>)</span>
                        <span class="shopping-recipes-arrow">‚ñº</span>
                    </div>
                    <div class="shopping-recipes-content">
                        <div class="shopping-recipes-inner" id="shoppingRecipesList"></div>
                    </div>
                </div>
                
                <div id="shoppingActions" style="display: none; margin-top: 15px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn-small" onclick="copyShoppingList()"><svg class="icon icon-sm"><use href="#icon-copy"/></svg> Copier</button>
                        <button class="btn-small btn-danger" onclick="clearShoppingList()"><svg class="icon icon-sm"><use href="#icon-trash"/></svg> Vider</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-bar">
        <button onclick="addToShoppingList()" id="generateBtn" disabled><svg class="icon icon-sm"><use href="#icon-cart"/></svg> <span id="generateBtnText">G√©n√©rer</span></button>
        <button onclick="deleteSelectedRecipes()" class="btn-danger" id="deleteSelectedBtn" style="display: none;"><svg class="icon icon-sm"><use href="#icon-trash"/></svg> Suppr.</button>
        <button onclick="clearSelection()" class="btn-outline" id="clearBtn" disabled><svg class="icon icon-sm"><use href="#icon-x"/></svg> D√©s√©lect.</button>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header"><h3><svg class="icon"><use href="#icon-upload"/></svg> Importer CSV</h3></div>
            <div class="modal-body">
                <p>Comment souhaitez-vous importer ces recettes ?</p>
                <p style="margin-top: 10px; font-size: 0.85em; color: var(--text-light);"><strong id="importFileInfo">0 recettes</strong> trouv√©es dans le fichier</p>
            </div>
            <div class="modal-footer">
                <button class="btn-outline btn-small" onclick="closeImportModal()">Annuler</button>
                <button class="btn-small" onclick="doImport('add')">Ajouter</button>
                <button class="btn-danger btn-small" onclick="doImport('replace')">Remplacer tout</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header"><h3 style="color: var(--danger);"><svg class="icon"><use href="#icon-trash"/></svg> Confirmer la suppression</h3></div>
            <div class="modal-body"><p id="deleteModalText">Supprimer X recettes ?</p></div>
            <div class="modal-footer">
                <button class="btn-outline btn-small" onclick="closeDeleteModal()">Annuler</button>
                <button class="btn-danger btn-small" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Unsaved Changes Modal -->
    <div class="modal-overlay" id="unsavedModal">
        <div class="modal">
            <div class="modal-header"><h3><svg class="icon"><use href="#icon-alert"/></svg> Modifications non sauv√©es</h3></div>
            <div class="modal-body"><p>Vous avez des modifications en cours. Abandonner ?</p></div>
            <div class="modal-footer">
                <button class="btn-outline btn-small" onclick="closeUnsavedModal()">Continuer l'√©dition</button>
                <button class="btn-danger btn-small" onclick="confirmAbandon()">Abandonner</button>
            </div>
        </div>
    </div>

    <!-- SVG Icons -->
    <svg style="display: none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
        <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></symbol>
        <symbol id="icon-star-filled" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        <symbol id="icon-cart" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></symbol>
        <symbol id="icon-filter" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
        <symbol id="icon-list" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></symbol>
        <symbol id="icon-grip" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></symbol>
        <symbol id="icon-shuffle" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></symbol>
        <symbol id="icon-download" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></symbol>
        <symbol id="icon-alert" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></symbol>
    </svg>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://fejvhzvpxsrzclsdsfnx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlanZoenZweHNyemNsc2RzZm54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjUxMTcsImV4cCI6MjA4MTkwMTExN30.bjaGtfZ7WHIyI8Vhkbpa-ftL4U9a88iYe6QA1hClr4A';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let recipes = [];
        let selectedRecipes = new Set();
        let allIngredients = new Set();
        let allCriteria = new Set();
        let editingRecipeId = null;
        let currentSort = 'alpha';
        let currentTab = 'recipes';
        let expandedRecipeId = null;
        let currentIngredients = [];
        let currentCriteriaList = [];
        let filterIngredientsList = [];
        let filterCriteriaList = [];
        let showOnlyFavorites = false;
        let currentShoppingList = {};
        let currentShoppingRecipes = new Set();
        let shoppingOrder = [];
        let autocompleteStates = {};
        let isMobile = 'ontouchstart' in window;
        
        // v7 new
        let randomModeIds = null; // null = normal mode, Set = random mode
        let pendingImportData = null;
        let hasUnsavedChanges = false;
        let pendingCloseAction = null;
        let visibleRecipeIds = [];

        // ============================================
        // SYNC STATUS
        // ============================================
        function setSyncStatus(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            dot.className = 'sync-dot';
            if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Sync...'; }
            else if (status === 'error') { dot.classList.add('error'); text.textContent = 'Erreur'; }
            else { text.textContent = 'OK'; }
        }

        // ============================================
        // AUTH
        // ============================================
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return false; }
            document.getElementById('userEmail').textContent = session.user.email;
            return true;
        }
        async function handleLogout() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadRecipes() {
            try {
                setSyncStatus('syncing');
                const { data, error } = await supabaseClient.from('recipes').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                recipes = (data || []).map(r => ({
                    id: r.id, name: r.name, ingredients: r.ingredients || [], double: r.double_portion || false,
                    criteria: r.criteria || [], usageCount: r.usage_count || 0, favorite: r.favorite || false
                }));
                updateAllIngredients();
                updateAllCriteria();
                updateStats();
                renderRecipes();
                updateButtonStates();
                renderTopCriteria();
                setSyncStatus('synced');
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
                document.getElementById('recipeList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Erreur de chargement</p><button onclick="loadRecipes()">R√©essayer</button></div>';
            }
        }

        function updateAllIngredients() { allIngredients.clear(); recipes.forEach(r => r.ingredients.forEach(i => allIngredients.add(i))); }
        function updateAllCriteria() { allCriteria.clear(); recipes.forEach(r => r.criteria.forEach(c => allCriteria.add(c))); }
        
        function updateStats() {
            document.getElementById('totalCount').textContent = recipes.length;
            document.getElementById('selectedCount').textContent = selectedRecipes.size;
            document.getElementById('favCount').textContent = recipes.filter(r => r.favorite).length;
        }
        
        function updateButtonStates() {
            const hasSelection = selectedRecipes.size > 0;
            document.getElementById('generateBtn').disabled = !hasSelection;
            document.getElementById('clearBtn').disabled = !hasSelection;
            document.getElementById('deleteSelectedBtn').style.display = hasSelection ? 'inline-flex' : 'none';
            document.getElementById('generateBtnText').textContent = currentShoppingRecipes.size > 0 ? 'Ajouter' : 'G√©n√©rer';
            
            // Update select all button text
            const allVisible = visibleRecipeIds.length > 0 && visibleRecipeIds.every(id => selectedRecipes.has(id));
            document.getElementById('selectAllBtn').innerHTML = allVisible ? '‚òê Tout d√©s√©lect.' : '‚òëÔ∏è Tout s√©lect.';
        }

        // ============================================
        // TOP 10 CRITERIA
        // ============================================
        function renderTopCriteria() {
            const critCounts = {};
            recipes.forEach(r => r.criteria.forEach(c => { critCounts[c] = (critCounts[c] || 0) + 1; }));
            const sorted = Object.entries(critCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            const colors = ['--crit-1','--crit-2','--crit-3','--crit-4','--crit-5','--crit-6','--crit-7','--crit-8','--crit-9','--crit-10'];
            
            document.getElementById('topCriteria').innerHTML = sorted.map(([name, count], i) => 
                `<button class="criteria-chip" style="background: var(${colors[i]})" onclick="addCriteria('${name.replace(/'/g, "\\'")}')">
                    ${name} <span class="count">${count}</span>
                </button>`
            ).join('');
        }

        // ============================================
        // PANELS
        // ============================================
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const btn = document.querySelector(`[data-panel="${panelId}"]`);
            const isOpen = panel.classList.contains('show');
            
            // Check unsaved changes before closing add panel
            if (panelId === 'addPanel' && !isOpen && hasUnsavedChanges) {
                pendingCloseAction = () => { closeAllPanels(); openPanel(panelId); };
                showUnsavedModal();
                return;
            }
            
            if (isOpen) {
                closePanel(panelId);
            } else {
                // Close others first (with unsaved check for addPanel)
                if (document.getElementById('addPanel').classList.contains('show') && panelId !== 'addPanel' && hasUnsavedChanges) {
                    pendingCloseAction = () => { closeAllPanels(); openPanel(panelId); };
                    showUnsavedModal();
                    return;
                }
                closeAllPanels();
                openPanel(panelId);
            }
        }
        
        function openPanel(panelId) {
            document.getElementById(panelId).classList.add('show');
            document.querySelector(`[data-panel="${panelId}"]`)?.classList.add('active');
            if (panelId === 'addPanel') {
                setTimeout(() => document.getElementById('recipeName').focus(), 100);
            }
        }
        
        function closePanel(panelId) {
            if (panelId === 'addPanel' && hasUnsavedChanges) {
                pendingCloseAction = () => { forceClosePanel(panelId); };
                showUnsavedModal();
                return;
            }
            forceClosePanel(panelId);
        }
        
        function forceClosePanel(panelId) {
            document.getElementById(panelId).classList.remove('show');
            document.querySelector(`[data-panel="${panelId}"]`)?.classList.remove('active');
            if (panelId === 'addPanel') {
                resetForm();
            }
        }
        
        function closeAllPanels() {
            ['addPanel', 'randomPanel', 'filterPanel'].forEach(id => {
                document.getElementById(id).classList.remove('show');
                document.querySelector(`[data-panel="${id}"]`)?.classList.remove('active');
            });
        }

        // ============================================
        // UNSAVED CHANGES
        // ============================================
        function checkUnsavedChanges() {
            const name = document.getElementById('recipeName').value.trim();
            hasUnsavedChanges = name.length > 0 || currentIngredients.length > 0 || currentCriteriaList.length > 0;
        }
        
        function showUnsavedModal() { document.getElementById('unsavedModal').classList.add('show'); }
        function closeUnsavedModal() { document.getElementById('unsavedModal').classList.remove('show'); pendingCloseAction = null; }
        function confirmAbandon() {
            closeUnsavedModal();
            hasUnsavedChanges = false;
            if (pendingCloseAction) { pendingCloseAction(); pendingCloseAction = null; }
        }

        // ============================================
        // AUTOCOMPLETE
        // ============================================
        function setupAutocomplete() {
            const configs = [
                { inputId: 'recipeIngredients', dropdownId: 'ingredientsAutocomplete', dataset: () => allIngredients, onSelect: addIngredient },
                { inputId: 'recipeCriteria', dropdownId: 'criteriaAutocomplete', dataset: () => allCriteria, onSelect: addCriteria },
                { inputId: 'filterIngredients', dropdownId: 'filterIngredientsAutocomplete', dataset: () => allIngredients, onSelect: addFilterIngredient },
                { inputId: 'filterCriteria', dropdownId: 'filterCriteriaAutocomplete', dataset: () => allCriteria, onSelect: addFilterCriteria }
            ];
            configs.forEach(cfg => {
                const input = document.getElementById(cfg.inputId);
                const dropdown = document.getElementById(cfg.dropdownId);
                autocompleteStates[cfg.inputId] = { idx: -1, items: [] };
                
                input.addEventListener('input', function() {
                    const q = this.value.trim();
                    if (q.length >= 2) showAutocomplete(cfg.inputId, cfg.dropdownId, getSuggestions(q, cfg.dataset()), q);
                    else hideAutocomplete(cfg.dropdownId);
                    if (cfg.inputId === 'recipeIngredients' || cfg.inputId === 'recipeCriteria' || cfg.inputId === 'recipeName') checkUnsavedChanges();
                });
                
                input.addEventListener('keydown', function(e) {
                    const st = autocompleteStates[cfg.inputId];
                    const isOpen = dropdown.classList.contains('show');
                    if (e.key === 'ArrowDown') { e.preventDefault(); if (isOpen && st.items.length) { st.idx = Math.min(st.idx + 1, st.items.length - 1); updateACSelection(cfg.dropdownId, st.idx); } }
                    else if (e.key === 'ArrowUp') { e.preventDefault(); if (isOpen && st.items.length) { st.idx = Math.max(st.idx - 1, 0); updateACSelection(cfg.dropdownId, st.idx); } }
                    else if (e.key === 'Tab') { if (isOpen && st.items.length) { e.preventDefault(); cfg.onSelect(st.idx >= 0 ? st.items[st.idx] : st.items[0]); this.value = ''; hideAutocomplete(cfg.dropdownId); } }
                    else if (e.key === 'Enter') { e.preventDefault(); if (isOpen && st.idx >= 0) cfg.onSelect(st.items[st.idx]); else if (this.value.trim()) { this.value.trim().split(';').forEach(v => v.trim() && cfg.onSelect(v.trim())); } this.value = ''; hideAutocomplete(cfg.dropdownId); }
                    else if (e.key === 'Escape') hideAutocomplete(cfg.dropdownId);
                });
                input.addEventListener('blur', () => setTimeout(() => hideAutocomplete(cfg.dropdownId), 200));
            });
            
            // Track name changes
            document.getElementById('recipeName').addEventListener('input', checkUnsavedChanges);
        }
        
        function getSuggestions(q, data) {
            q = q.toLowerCase();
            return Array.from(data).filter(i => i.toLowerCase().includes(q))
                .sort((a, b) => a.toLowerCase().startsWith(q) ? -1 : b.toLowerCase().startsWith(q) ? 1 : a.localeCompare(b))
                .slice(0, 8);
        }
        function showAutocomplete(inputId, dropdownId, items, q) {
            const dd = document.getElementById(dropdownId); const st = autocompleteStates[inputId];
            if (!items.length) { hideAutocomplete(dropdownId); return; }
            st.items = items; st.idx = -1;
            dd.innerHTML = items.map((s, i) => `<div class="autocomplete-item" data-i="${i}" onmousedown="selectAC('${inputId}','${dropdownId}',${i})">${s.replace(new RegExp('(' + q + ')', 'gi'), '<span class="autocomplete-highlight">$1</span>')}</div>`).join('');
            dd.classList.add('show');
        }
        function hideAutocomplete(id) { document.getElementById(id)?.classList.remove('show'); }
        function updateACSelection(id, idx) {
            document.getElementById(id).querySelectorAll('.autocomplete-item').forEach((el, i) => {
                el.classList.toggle('selected', i === idx);
                if (i === idx) el.scrollIntoView({ block: 'nearest' });
            });
        }
        function selectAC(inputId, dropdownId, i) {
            const st = autocompleteStates[inputId];
            const handlers = { recipeIngredients: addIngredient, recipeCriteria: addCriteria, filterIngredients: addFilterIngredient, filterCriteria: addFilterCriteria };
            handlers[inputId](st.items[i]);
            document.getElementById(inputId).value = '';
            hideAutocomplete(dropdownId);
        }

        // ============================================
        // RENDER RECIPES
        // ============================================
        function renderRecipes() {
            const list = document.getElementById('recipeList');
            const search = document.getElementById('searchBox').value.toLowerCase();
            
            let filtered = recipes.filter(r => {
                // Random mode filter
                if (randomModeIds !== null && !randomModeIds.has(r.id)) return false;
                
                if (search && !r.name.toLowerCase().includes(search)) return false;
                if (showOnlyFavorites && !r.favorite) return false;
                for (let f of filterIngredientsList) {
                    const has = r.ingredients.some(i => i.toLowerCase().includes(f.name.toLowerCase()));
                    if (f.mode === 'include' && !has) return false;
                    if (f.mode === 'exclude' && has) return false;
                }
                for (let f of filterCriteriaList) {
                    const has = r.criteria.some(c => c.toLowerCase().includes(f.name.toLowerCase()));
                    if (f.mode === 'include' && !has) return false;
                    if (f.mode === 'exclude' && has) return false;
                }
                return true;
            });
            
            if (currentSort === 'alpha') filtered.sort((a, b) => a.name.localeCompare(b.name));
            else filtered.sort((a, b) => b.usageCount - a.usageCount);
            
            visibleRecipeIds = filtered.map(r => r.id);
            
            if (recipes.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëã</div><p>Bienvenue ! Ajoutez votre premi√®re recette.</p><button onclick="togglePanel(\'addPanel\')">Ajouter</button></div>';
                return;
            }
            if (!filtered.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>Aucune recette</p><button class="btn-outline btn-small" onclick="resetFilters()">R√©initialiser</button></div>';
                return;
            }
            
            list.innerHTML = filtered.map(r => renderCompactRecipe(r)).join('');
            if (isMobile) setupSwipe();
            updateButtonStates();
        }
        
        function renderCompactRecipe(r) {
            const sel = selectedRecipes.has(r.id);
            const exp = expandedRecipeId === r.id;
            
            let html = `<div class="recipe-compact-wrapper" data-id="${r.id}">
                <div class="swipe-actions">
                    <button class="swipe-action fav" onclick="toggleFavorite('${r.id}')"><svg class="icon"><use href="#icon-star${r.favorite ? '-filled' : ''}"/></svg></button>
                    <button class="swipe-action edit" onclick="editRecipe('${r.id}')"><svg class="icon"><use href="#icon-edit"/></svg></button>
                    <button class="swipe-action delete" onclick="deleteRecipe('${r.id}')"><svg class="icon"><use href="#icon-trash"/></svg></button>
                </div>
                <div class="recipe-compact ${sel ? 'selected' : ''} ${r.favorite ? 'favorite' : ''}" data-id="${r.id}" style="${exp ? 'border-radius: 8px 8px 0 0;' : ''}">
                    <div class="recipe-checkbox-zone" onclick="toggleSelection('${r.id}')">
                        <div class="recipe-compact-checkbox"><svg class="icon icon-sm"><use href="#icon-check"/></svg></div>
                    </div>
                    <div class="recipe-compact-main" onclick="toggleExp('${r.id}')">
                        <div class="recipe-compact-name">${r.favorite ? '<svg class="icon icon-sm"><use href="#icon-star-filled"/></svg>' : ''}${r.name}</div>
                        <div class="recipe-compact-meta">
                            ${r.usageCount > 0 ? `<span>${r.usageCount}√ó</span>` : ''}
                            ${r.criteria.length ? `<span>${r.criteria[0]}</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>`;
            
            if (exp) {
                html += `<div class="recipe-inline-detail">
                    <div class="recipe-inline-detail-section">
                        <strong><svg class="icon icon-sm"><use href="#icon-list"/></svg> Ingr√©dients</strong>
                        <p>${r.ingredients.join(' ‚Ä¢ ')}</p>
                    </div>
                    <div class="recipe-inline-detail-tags">
                        ${r.usageCount > 0 ? `<span class="recipe-tag usage">${r.usageCount}√ó</span>` : ''}
                        ${r.criteria.map(c => `<span class="recipe-tag criteria">${c}</span>`).join('')}
                    </div>
                    <div class="recipe-inline-actions">
                        <button class="btn-small" onclick="toggleFavorite('${r.id}')"><svg class="icon icon-sm"><use href="#icon-star${r.favorite ? '-filled' : ''}"/></svg></button>
                        <button class="btn-small" onclick="editRecipe('${r.id}')"><svg class="icon icon-sm"><use href="#icon-edit"/></svg></button>
                        <button class="btn-small btn-danger" onclick="deleteRecipe('${r.id}')"><svg class="icon icon-sm"><use href="#icon-trash"/></svg></button>
                    </div>
                </div>`;
            }
            return html;
        }

        // ============================================
        // FILTERS
        // ============================================
        function addFilterIngredient(n) { n = n.trim(); if (!n || filterIngredientsList.some(f => f.name.toLowerCase() === n.toLowerCase())) return; filterIngredientsList.push({ name: n, mode: 'include' }); renderFilterTags(); renderRecipes(); }
        function addFilterCriteria(n) { n = n.trim(); if (!n || filterCriteriaList.some(f => f.name.toLowerCase() === n.toLowerCase())) return; filterCriteriaList.push({ name: n, mode: 'include' }); renderFilterTags(); renderRecipes(); }
        
        function renderFilterTags() {
            document.getElementById('filterIngredientsTags').innerHTML = filterIngredientsList.map((f, i) => `<div class="tag ${f.mode}"><span onclick="filterIngredientsList[${i}].mode=filterIngredientsList[${i}].mode==='include'?'exclude':'include';renderFilterTags();renderRecipes()" style="cursor:pointer">${f.mode === 'include' ? '‚úì' : '‚úó'} ${f.name}</span><span class="tag-remove" onclick="filterIngredientsList.splice(${i},1);renderFilterTags();renderRecipes()">‚úï</span></div>`).join('');
            document.getElementById('filterCriteriaTags').innerHTML = filterCriteriaList.map((f, i) => `<div class="tag ${f.mode}"><span onclick="filterCriteriaList[${i}].mode=filterCriteriaList[${i}].mode==='include'?'exclude':'include';renderFilterTags();renderRecipes()" style="cursor:pointer">${f.mode === 'include' ? '‚úì' : '‚úó'} ${f.name}</span><span class="tag-remove" onclick="filterCriteriaList.splice(${i},1);renderFilterTags();renderRecipes()">‚úï</span></div>`).join('');
        }
        
        function toggleFavoritesFilter() {
            showOnlyFavorites = !showOnlyFavorites;
            const b = document.getElementById('favoritesBtn');
            b.classList.toggle('active', showOnlyFavorites);
            renderRecipes();
        }
        
        function resetFilters() {
            filterIngredientsList = [];
            filterCriteriaList = [];
            showOnlyFavorites = false;
            randomModeIds = null;
            document.getElementById('searchBox').value = '';
            document.getElementById('filterIngredients').value = '';
            document.getElementById('filterCriteria').value = '';
            document.getElementById('favoritesBtn').classList.remove('active');
            document.getElementById('randomModeBanner').classList.remove('show');
            renderFilterTags();
            renderRecipes();
        }

        // ============================================
        // SHOPPING LIST
        // ============================================
        async function addToShoppingList() {
            for (const id of selectedRecipes) {
                const r = recipes.find(x => x.id === id);
                if (r && !currentShoppingRecipes.has(id)) {
                    currentShoppingRecipes.add(id);
                    r.ingredients.forEach(i => { currentShoppingList[i] = (currentShoppingList[i] || 0) + 1; });
                    await incrementUsage(id);
                    r.usageCount++;
                }
            }
            shoppingOrder = Object.entries(currentShoppingList).sort((a, b) => b[1] - a[1]).map(e => e[0]);
            updateListTitle();
            renderShoppingList();
            renderShoppingRecipes();
            document.getElementById('shoppingActions').style.display = 'flex';
            document.getElementById('shoppingRecipesSection').style.display = 'block';
            selectedRecipes.clear();
            updateStats();
            updateButtonStates();
            renderRecipes();
            if (isMobile) switchTab('shopping');
        }
        
        function updateListTitle() {
            const d = new Date();
            const months = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
            document.getElementById('listTitle').textContent = `${d.getDate()} ${months[d.getMonth()]} ‚Ä¢ ${currentShoppingRecipes.size} recette${currentShoppingRecipes.size > 1 ? 's' : ''}`;
            document.getElementById('listTitleContainer').style.display = currentShoppingRecipes.size ? 'block' : 'none';
            document.getElementById('shoppingRecipesCount').textContent = currentShoppingRecipes.size;
        }
        
        function renderShoppingList() {
            const c = document.getElementById('shoppingList');
            if (!shoppingOrder.length) {
                c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõí</div><p>S√©lectionnez des recettes puis g√©n√©rez</p></div>';
                document.getElementById('shoppingActions').style.display = 'none';
                document.getElementById('shoppingRecipesSection').style.display = 'none';
                document.getElementById('listTitleContainer').style.display = 'none';
                return;
            }
            c.innerHTML = shoppingOrder.map((name, idx) => {
                const q = currentShoppingList[name] || 0;
                return `<div class="shopping-item ${q === 0 ? 'zero' : ''}" draggable="true" data-name="${name}" data-idx="${idx}">
                    <div class="drag-handle"><svg class="icon"><use href="#icon-grip"/></svg></div>
                    <span class="shopping-item-name">${name}</span>
                    <div class="shopping-item-controls">
                        <button class="qty-btn minus" onclick="changeQty('${name.replace(/'/g, "\\'")}', -1)">‚àí</button>
                        <span class="shopping-item-count">√ó${q}</span>
                        <button class="qty-btn plus" onclick="changeQty('${name.replace(/'/g, "\\'")}', 1)">+</button>
                    </div>
                </div>`;
            }).join('');
            setupDragDrop();
        }
        
        // ============================================
        // DRAG & DROP
        // ============================================
        let draggedItem = null, draggedIdx = null;
        
        function setupDragDrop() {
            document.querySelectorAll('.shopping-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('drop', handleDrop);
                
                const handle = item.querySelector('.drag-handle');
                let touchStartY = 0, isDragging = false, placeholder = null;
                
                handle.addEventListener('touchstart', function(e) {
                    e.preventDefault(); isDragging = true; draggedItem = item;
                    draggedIdx = parseInt(item.dataset.idx); touchStartY = e.touches[0].clientY;
                    item.classList.add('dragging');
                    placeholder = document.createElement('div'); placeholder.className = 'drop-indicator';
                }, { passive: false });
                
                handle.addEventListener('touchmove', function(e) {
                    if (!isDragging) return; e.preventDefault();
                    const touchCurrentY = e.touches[0].clientY;
                    item.style.transform = `translateY(${touchCurrentY - touchStartY}px)`; item.style.zIndex = '100';
                    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                    const allItems = [...document.querySelectorAll('.shopping-item:not(.dragging)')];
                    for (const other of allItems) {
                        const rect = other.getBoundingClientRect();
                        if (touchCurrentY < rect.top + rect.height / 2) { other.parentNode.insertBefore(placeholder, other); break; }
                        else { other.parentNode.insertBefore(placeholder, other.nextSibling); }
                    }
                }, { passive: false });
                
                handle.addEventListener('touchend', function() {
                    if (!isDragging) return; isDragging = false;
                    item.classList.remove('dragging'); item.style.transform = ''; item.style.zIndex = '';
                    if (placeholder && placeholder.parentNode) {
                        const allItems = [...document.querySelectorAll('.shopping-item, .drop-indicator')];
                        const newIdx = allItems.indexOf(placeholder);
                        if (newIdx !== draggedIdx && newIdx >= 0) {
                            const movedName = shoppingOrder[draggedIdx];
                            shoppingOrder.splice(draggedIdx, 1);
                            shoppingOrder.splice(newIdx > draggedIdx ? newIdx - 1 : newIdx, 0, movedName);
                        }
                        placeholder.remove();
                    }
                    renderShoppingList();
                });
            });
        }
        
        function handleDragStart(e) { draggedItem = this; draggedIdx = parseInt(this.dataset.idx); this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragEnd() { this.classList.remove('dragging'); document.querySelectorAll('.drop-indicator').forEach(el => el.remove()); }
        function handleDragEnter(e) {
            e.preventDefault(); if (this === draggedItem) return;
            document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
            const indicator = document.createElement('div'); indicator.className = 'drop-indicator';
            const rect = this.getBoundingClientRect();
            if (e.clientY < rect.top + rect.height / 2) this.parentNode.insertBefore(indicator, this);
            else this.parentNode.insertBefore(indicator, this.nextSibling);
        }
        function handleDrop(e) {
            e.preventDefault(); if (this === draggedItem) return;
            const indicator = document.querySelector('.drop-indicator');
            if (indicator) {
                const allItems = [...document.querySelectorAll('.shopping-item, .drop-indicator')];
                const newIdx = allItems.indexOf(indicator);
                if (newIdx !== draggedIdx && newIdx >= 0) {
                    const movedName = shoppingOrder[draggedIdx];
                    shoppingOrder.splice(draggedIdx, 1);
                    shoppingOrder.splice(newIdx > draggedIdx ? newIdx - 1 : newIdx, 0, movedName);
                }
                indicator.remove();
            }
            renderShoppingList();
        }
        
        function changeQty(n, d) { if (currentShoppingList[n] !== undefined) { currentShoppingList[n] = Math.max(0, currentShoppingList[n] + d); renderShoppingList(); } }
        
        function toggleShoppingRecipes() { document.getElementById('shoppingRecipesSection').classList.toggle('open'); }
        
        function renderShoppingRecipes() {
            document.getElementById('shoppingRecipesList').innerHTML = Array.from(currentShoppingRecipes).map(id => {
                const r = recipes.find(x => x.id === id);
                return r ? `<div class="shopping-recipe-item"><span>${r.name}</span><button class="remove-recipe-btn" onclick="removeFromList('${id}')">Retirer</button></div>` : '';
            }).join('');
            document.getElementById('shoppingRecipesCount').textContent = currentShoppingRecipes.size;
        }
        
        function removeFromList(id) {
            const r = recipes.find(x => x.id === id);
            if (r && currentShoppingRecipes.has(id)) {
                r.ingredients.forEach(i => { if (currentShoppingList[i]) { currentShoppingList[i]--; if (currentShoppingList[i] <= 0) { delete currentShoppingList[i]; shoppingOrder = shoppingOrder.filter(n => n !== i); } } });
                currentShoppingRecipes.delete(id);
                updateListTitle(); renderShoppingList(); renderShoppingRecipes(); updateButtonStates();
            }
        }
        
        function clearShoppingList() {
            if (!shoppingOrder.length || !confirm('Vider toute la liste ?')) return;
            currentShoppingList = {}; currentShoppingRecipes.clear(); shoppingOrder = [];
            renderShoppingList(); renderShoppingRecipes(); updateListTitle(); updateButtonStates();
        }
        
        function copyShoppingList() {
            let t = ''; shoppingOrder.forEach(n => { const q = currentShoppingList[n]; if (q > 0) t += `‚òê ${n} √ó${q}\n`; });
            navigator.clipboard.writeText(t).then(() => alert('Liste copi√©e !'));
        }

        // ============================================
        // IMPORT / EXPORT
        // ============================================
        document.getElementById('csvImport').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            closeOptionsMenu();
            
            const text = await file.text();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) { alert('Fichier CSV vide ou invalide'); e.target.value = ''; return; }
            
            const toImport = [];
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 2 && parts[0].trim()) {
                    toImport.push({
                        name: parts[0].trim(),
                        ingredients: parts[1].split(';').map(s => s.trim()).filter(s => s),
                        double_portion: parts[2] ? parts[2].trim().toLowerCase() === 'oui' : false,
                        criteria: parts[3] ? parts[3].split(';').map(s => s.trim()).filter(s => s) : [],
                        usage_count: parts[4] ? parseInt(parts[4]) || 0 : 0,
                        favorite: parts[5] ? parts[5].trim().toLowerCase() === 'oui' : false
                    });
                }
            }
            
            if (!toImport.length) { alert('Aucune recette valide'); e.target.value = ''; return; }
            
            pendingImportData = toImport;
            document.getElementById('importFileInfo').textContent = `${toImport.length} recette${toImport.length > 1 ? 's' : ''} trouv√©e${toImport.length > 1 ? 's' : ''}`;
            document.getElementById('importModal').classList.add('show');
            e.target.value = '';
        });
        
        function closeImportModal() { document.getElementById('importModal').classList.remove('show'); pendingImportData = null; }
        
        async function doImport(mode) {
            if (!pendingImportData) return;
            closeImportModal();
            
            try {
                setSyncStatus('syncing');
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (mode === 'replace') {
                    // Delete all existing recipes
                    const { error: delError } = await supabaseClient.from('recipes').delete().eq('user_id', session.user.id);
                    if (delError) throw delError;
                }
                
                // Add user_id to each recipe
                const withUserId = pendingImportData.map(r => ({ ...r, user_id: session.user.id }));
                const { error } = await supabaseClient.from('recipes').insert(withUserId);
                if (error) throw error;
                
                alert(`‚úÖ ${pendingImportData.length} recettes ${mode === 'replace' ? 'import√©es (anciennes supprim√©es)' : 'ajout√©es'} !`);
                pendingImportData = null;
                await loadRecipes();
            } catch (error) {
                console.error('Erreur:', error);
                setSyncStatus('error');
                alert('Erreur lors de l\'import');
            }
        }

        function exportCSV() {
            if (!recipes.length) { alert('Aucune recette √† exporter'); return; }
            let csv = 'Nom de la recette,Ingr√©dients,Double portion,Crit√®res,Utilisations,Favori\n';
            recipes.forEach(r => {
                csv += [r.name, r.ingredients.join(';'), r.double ? 'oui' : 'non', r.criteria.join(';'), r.usageCount, r.favorite ? 'oui' : 'non'].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `recettes_${new Date().toISOString().split('T')[0]}.csv`; a.click();
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function toggleOptionsMenu() { document.getElementById('optionsMenu').classList.toggle('show'); }
        function closeOptionsMenu() { document.getElementById('optionsMenu').classList.remove('show'); }
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.mobile-tabs button').forEach(btn => btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab === 'recipes' ? 'recettes' : 'liste')));
            document.getElementById('recipesSection').classList.toggle('hidden-mobile', tab !== 'recipes');
            document.getElementById('recipesSection').classList.toggle('show-mobile', tab === 'recipes');
            document.getElementById('shoppingSection').classList.toggle('hidden-mobile', tab !== 'shopping');
            document.getElementById('shoppingSection').classList.toggle('show-mobile', tab === 'shopping');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('searchBox').addEventListener('input', renderRecipes);
        document.addEventListener('click', e => { if (!e.target.closest('.header-right')) closeOptionsMenu(); });

        // ============================================
        // INIT
        // ============================================
        (async () => {
            setupAutocomplete();
            if (await checkAuth()) {
                await loadRecipes();
            }
        })();
    </script>
</body>
</html>
